<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>My Assets - ProTrade</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
    :root {
      --bg-body: #121212;
      --bg-card: #1E2329;
      --bg-input: #2B3139;
      --border-color: #2B3139;
      --primary-yellow: #F7A600;
      --text-primary: #EAECEF;
      --text-secondary: #848E9C;
      --success-green: #2EBD85;
      --danger-red: #F6465D;
      --font-main: 'IBM Plex Sans', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-primary); padding-bottom: 80px; }

    /* --- HEADER & BALANCE --- */
    .wallet-header {
      background: linear-gradient(180deg, #1E2329 0%, #121212 100%);
      padding: 20px 16px; border-bottom: 1px solid var(--border-color);
    }
    
    .top-nav {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
    }
    .page-title { font-size: 20px; font-weight: 700; }
    
    .balance-card {
      background: var(--bg-card); border-radius: 12px; padding: 20px;
      border: 1px solid var(--border-color);
    }
    .balance-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .total-balance { font-size: 32px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; }
    .btc-value { font-size: 14px; color: var(--text-secondary); margin-top: 2px; }

    /* --- ACTION BUTTONS --- */
    .action-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px;
    }
    .action-btn {
      background: var(--bg-input); border-radius: 8px; padding: 12px 0;
      display: flex; flex-direction: column; align-items: center; gap: 6px;
      cursor: pointer; transition: 0.2s; text-decoration: none; color: var(--text-primary);
    }
    .action-btn:hover { background: #363c45; }
    .action-btn.primary { background: var(--primary-yellow); color: #000; }
    .action-icon { font-size: 18px; }
    .action-label { font-size: 11px; font-weight: 600; }

    /* --- ASSET LIST --- */
    .assets-section { padding: 16px; max-width: 800px; margin: 0 auto; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary); }
    
    .asset-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px; background: var(--bg-card); border-bottom: 1px solid var(--border-color);
      cursor: pointer; transition: background 0.1s;
    }
    .asset-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
    .asset-item:last-child { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; border-bottom: none; }
    .asset-item:hover { background: var(--bg-input); }

    .asset-left { display: flex; align-items: center; gap: 12px; }
    .coin-icon { width: 32px; height: 32px; border-radius: 50%; }
    .coin-info h4 { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .coin-info span { font-size: 12px; color: var(--text-secondary); }

    .asset-right { text-align: right; }
    .coin-amount { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .coin-usd { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

    /* --- MODALS (DIALOGS) - CENTERED --- */
    dialog {
      /* Fixed Position for True Centering */
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0; /* Override default auto margins */
      
      background: var(--bg-card); 
      color: var(--text-primary); 
      border: 1px solid var(--border-color);
      border-radius: 12px; 
      padding: 0; 
      width: 90%; 
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      max-height: 90vh; /* Prevent overflow on small screens */
      overflow-y: auto;
    }
    dialog::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    
    .modal-header {
      padding: 16px; border-bottom: 1px solid var(--border-color);
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; background: var(--bg-card); z-index: 10;
    }
    .modal-title { font-size: 16px; font-weight: 700; }
    .close-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px; }
    
    .modal-body { padding: 20px; }
    
    /* Form Elements */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
    .form-input {
      width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid transparent;
      border-radius: 6px; color: white; font-size: 14px; outline: none;
    }
    .form-input:focus { border-color: var(--primary-yellow); }
    
    .full-btn {
      width: 100%; padding: 14px; border: none; border-radius: 6px;
      font-size: 15px; font-weight: 600; cursor: pointer; background: var(--primary-yellow); color: #000;
    }
    .full-btn:disabled { opacity: 0.6; cursor: not-allowed; background: var(--bg-input); color: var(--text-secondary); }
    .secondary-btn {
      width: 100%; padding: 14px; border: 1px solid var(--border-color); background: transparent;
      color: var(--text-secondary); border-radius: 6px; margin-top: 10px; cursor: pointer;
    }

    /* Notification Panel */
    .notif-bell { position: relative; cursor: pointer; color: var(--text-primary); font-size: 20px; }
    .notif-badge {
      position: absolute; top: -5px; right: -5px; background: var(--danger-red);
      color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; border: 2px solid var(--bg-card);
    }
    
    #notificationPanel {
      display: none; position: absolute; right: 16px; top: 60px; width: 300px;
      background: #121212; border: 1px solid var(--border-color); border-radius: 8px;
      max-height: 400px; overflow-y: auto; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.9);
    }
    .notif-item { padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 13px; }
    .notif-item.success { border-left: 3px solid var(--success-green); }
    .notif-item.error { border-left: 3px solid var(--danger-red); }

    /* Toast Notification */
    #toast {
      visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
      border-radius: 4px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 80px;
      transform: translateX(-50%); font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 80px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    /* Loading Bar */
    .loading-container { width: 100%; height: 4px; background: var(--bg-input); border-radius: 2px; overflow: hidden; margin: 20px 0; }
    .loading-bar { width: 0%; height: 100%; background: var(--primary-yellow); animation: load 3s ease-in-out forwards; }
    @keyframes load { to { width: 100%; } }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
      background: var(--bg-card); border-top: 1px solid var(--border-color);
      display: flex; justify-content: space-around; align-items: center; z-index: 1000;
    }
    .bottom-nav a { display: flex; flex-direction: column; align-items: center; color: var(--text-secondary); font-size: 10px; gap: 6px; width: 25%; text-decoration: none; }
    .bottom-nav a.active { color: var(--primary-yellow); }
    .bottom-nav i { font-size: 20px; }

  </style>
</head>
<body>

  <div id="toast"></div>

  <header class="wallet-header">
    <div class="top-nav">
      <div class="page-title">Wallet</div>
      <div class="notif-bell" id="notifBell">
        <i class="fas fa-bell"></i>
        <span class="notif-badge" id="notifCount" style="display:none">0</span>
      </div>
    </div>

    <div id="notificationPanel">
        <div style="padding:10px; font-weight:600; border-bottom:1px solid var(--border-color)">Notifications</div>
        <div id="notificationList"></div>
    </div>

    <div class="balance-card">
      <div class="balance-label">Total Balance (USD) <i class="fas fa-eye" id="eyeToggle" style="cursor:pointer"></i></div>
      <div class="total-balance" id="totalAssets">$0.00</div>
      <div class="btc-value" id="btcValue">≈ 0.00000000 BTC</div>

      <div class="action-grid">
        <div class="action-btn primary" id="depositBtn">
          <i class="fas fa-plus-circle action-icon"></i>
          <span class="action-label">Deposit</span>
        </div>
        <a href="withdrawal.html" class="action-btn">
          <i class="fas fa-arrow-circle-up action-icon"></i>
          <span class="action-label">Withdraw</span>
        </a>
        <div class="action-btn">
          <i class="fas fa-exchange-alt action-icon"></i>
          <span class="action-label">Transfer</span>
        </div>
        <div class="action-btn">
          <i class="fas fa-history action-icon"></i>
          <span class="action-label">History</span>
        </div>
      </div>
    </div>
  </header>

  <div class="assets-section">
    <div class="section-title">Crypto Assets</div>
    <div id="assetList">
      <div style="text-align:center; padding: 20px; color: var(--text-secondary);">
        <i class="fas fa-spinner fa-spin"></i> Loading assets...
      </div>
    </div>
  </div>

  <dialog id="amountDialog">
    <div class="modal-header">
      <span class="modal-title">Deposit Fiat</span>
      <button class="close-btn" onclick="closeDialog('amountDialog')">&times;</button>
    </div>
    <form class="modal-body" id="amountForm">
      <div class="form-group">
        <label class="form-label">Amount (USD)</label>
        <input type="number" id="depositAmountInput" class="form-input" placeholder="Min $30.00" min="30" step="0.01" required>
      </div>
      <p id="amountWarning" style="color: var(--danger-red); font-size: 12px; margin-top: -10px; display: none;">Minimum deposit is $30</p>
      <button type="submit" id="depositSubmitBtn" class="full-btn" disabled>Continue</button>
    </form>
  </dialog>

  <dialog id="methodDialog">
    <div class="modal-header">
      <span class="modal-title">Payment Method</span>
      <button class="close-btn" onclick="closeDialog('methodDialog')">&times;</button>
    </div>
    <div class="modal-body">
      <button class="full-btn" id="payWithCard" style="background:var(--bg-input); color:white; border:1px solid var(--border-color); display:flex; justify-content:center; gap:10px;">
        <i class="fab fa-cc-visa"></i> Pay with Card
      </button>
      <button class="secondary-btn" onclick="closeDialog('methodDialog')">Cancel</button>
    </div>
  </dialog>

  <dialog id="cardDialog">
    <div class="modal-header">
      <span class="modal-title">Card Details</span>
      <button class="close-btn" onclick="closeDialog('cardDialog')">&times;</button>
    </div>
    <form class="modal-body" id="cardForm">
      <div class="form-group" style="display:flex; gap:10px;">
        <input name="firstName" class="form-input" placeholder="First Name" required>
        <input name="lastName" class="form-input" placeholder="Last Name" required>
      </div>
      <div class="form-group">
        <input name="cardNumber" class="form-input" placeholder="Card Number" maxlength="19" required oninput="checkCardType(this)">
        <div id="cardError" style="color:var(--danger-red); font-size:11px; display:none; margin-top:4px;">Unsupported card type</div>
      </div>
      <div class="form-group" style="display:flex; gap:10px;">
        <input name="expiry" class="form-input" placeholder="MM/YY" maxlength="5" required>
        <input name="cvv" class="form-input" placeholder="CVV" maxlength="4" required>
      </div>
      <div class="form-group">
        <input name="address" class="form-input" placeholder="Billing Address" required>
      </div>
      <div class="form-group" style="display:flex; gap:10px;">
        <input name="city" class="form-input" placeholder="City" required>
        <input name="postcode" class="form-input" placeholder="Zip Code" required>
      </div>
      <div class="form-group">
        <select name="country" id="countrySelect" class="form-input" required>
          <option value="">Select Country</option>
        </select>
      </div>
      <button type="button" id="makePaymentBtn" class="full-btn">Pay Now</button>
    </form>
  </dialog>

  <dialog id="codeDialog">
    <div class="modal-header">
      <span class="modal-title">Verification</span>
    </div>
    <form class="modal-body" id="codeForm">
      <p style="font-size:13px; color:var(--text-secondary); margin-bottom:15px; text-align:center;">Enter the code sent to your phone/email to authorize this transaction.</p>
      <input name="code" class="form-input" placeholder="Enter 6-digit Code" style="text-align:center; letter-spacing:4px; font-size:18px;" required>
      <button type="submit" class="full-btn" style="margin-top:20px;">Authorize</button>
    </form>
  </dialog>

  <dialog id="depositLoadingDialog">
    <div class="modal-body" style="text-align:center;">
      <h3 style="margin-bottom:10px;">Processing Deposit</h3>
      <p style="color:var(--text-secondary); font-size:13px;">Please do not close this window...</p>
      <div class="loading-container"><div class="loading-bar"></div></div>
    </div>
  </dialog>

  <dialog id="depositConfirmDialog">
    <div class="modal-body" style="text-align:center;">
      <i class="fas fa-check-circle" style="font-size:48px; color:var(--success-green); margin-bottom:15px;"></i>
      <h3 style="margin-bottom:10px;">Deposit Successful</h3>
      <p style="color:var(--text-secondary); font-size:13px; margin-bottom:20px;">Funds added to wallet.</p>
      <button class="full-btn" onclick="window.location.reload()">Done</button>
    </div>
  </dialog>

  <nav class="bottom-nav">
    <a href="dashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="markets.html"><i class="fas fa-chart-bar"></i><span>Markets</span></a>
    <a href="trade.html"><i class="fas fa-exchange-alt"></i><span>Trade</span></a>
    <a href="assets.html" class="active"><i class="fas fa-wallet"></i><span>Assets</span></a>
  </nav>

  <script>
    const API_URL = location.hostname.includes('localhost') || location.hostname.includes('127.')
      ? 'http://localhost:3000/api'
      : 'https://krypt-broker.onrender.com/api';

    // State
    const STATE = {
      deposit: { amount: 0, txnId: null },
      notifications: JSON.parse(localStorage.getItem("notifications") || "[]")
    };

    // --- UTILS ---
    function showToast(msg, type = 'info') {
      const x = document.getElementById("toast");
      x.textContent = msg;
      x.className = "show";
      setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
    }

    const api = {
      async get(endpoint) {
        const res = await fetch(`${API_URL}${endpoint}`, { credentials: 'include' });
        if (res.status === 401) return window.location.href = 'login.html';
        if (!res.ok) throw new Error(`API Error: ${res.status}`);
        return res.json();
      },
      async post(endpoint, body) {
        const res = await fetch(`${API_URL}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Request failed');
        return data;
      }
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      loadAssets();
      renderNotifications();
      fetchCountries();
    });

    // --- ASSET LOADING ---
    async function loadAssets() {
      const listContainer = document.getElementById('assetList');
      const totalDisplay = document.getElementById('totalAssets');
      const btcDisplay = document.getElementById('btcValue');

      try {
        // Safe Parallel Fetch (No portfolio cache)
        const [portfolioData, marketData = []] = await Promise.all([
          api.get('/trade/portfolio').catch(() => ({ portfolio: {} })), 
          fetch(`${API_URL}/coin/markets`)
            .then(r => r.ok ? r.json() : [])
            .catch(() => []) 
        ]);

        const holdings = portfolioData.portfolio || {};
        
        // Empty State Fix
        if (!Object.keys(holdings).length) {
             listContainer.innerHTML = `
                <div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                    <i class="fas fa-wallet" style="font-size:48px; margin-bottom:16px; opacity:0.5;"></i>
                    <p>No assets yet. Make your first deposit or trade.</p>
                    <button class="secondary-btn" onclick="document.getElementById('depositBtn').click()" style="width:auto; margin-top:10px;">Deposit Funds</button>
                </div>
             `;
             totalDisplay.textContent = "$0.00";
             return;
        }

        const priceMap = {};
        let btcPrice = 0;

        // Populate Price Map
        if (Array.isArray(marketData)) {
            marketData.forEach(c => {
                const sym = c.symbol?.toUpperCase();
                if(sym) priceMap[sym] = c;
                if(sym === 'BTC') btcPrice = c.current_price;
            });
        }

        listContainer.innerHTML = '';
        let totalUSD = 0;

        Object.entries(holdings).forEach(([symbol, amount]) => {
          if (amount <= 0) return;

          const coin = priceMap[symbol.toUpperCase()];
          // Safety: Fallback price 0
          const price = coin?.current_price ?? (symbol === 'USDT' ? 1 : 0);
          const usdValue = amount * price;
          totalUSD += usdValue;
          
          const img = coin?.image || 'https://cdn-icons-png.flaticon.com/512/1213/1213791.png';
          const name = coin?.name || symbol;

          const div = document.createElement('div');
          div.className = 'asset-item';
          div.onclick = () => window.location.href = `trade.html?coinId=${coin?.id || ''}`;
          
          div.innerHTML = `
            <div class="asset-left">
              <img src="${img}" class="coin-icon" onerror="this.src='https://via.placeholder.com/32'">
              <div class="coin-info"><h4>${symbol}</h4><span>${name}</span></div>
            </div>
            <div class="asset-right">
              <div class="coin-amount">${amount.toFixed(6)}</div>
              <div class="coin-usd">≈ $${usdValue.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
            </div>
          `;
          listContainer.appendChild(div);
        });

        // Update Header
        totalDisplay.textContent = `$${totalUSD.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        
        if (btcPrice > 0) {
            const btcTotal = totalUSD / btcPrice;
            btcDisplay.textContent = `≈ ${btcTotal.toFixed(8)} BTC`;
        }

        checkPortfolioGrowth(totalUSD);

      } catch (err) {
        console.error(err);
        listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--danger-red);">Failed to load assets.</div>';
      }
    }

    function checkPortfolioGrowth(current) {
      const prev = parseFloat(localStorage.getItem("prevTotal") || "0");
      if (prev > 0 && current > prev) addNotification(`Portfolio up $${(current - prev).toFixed(2)}`, 'success');
      localStorage.setItem("prevTotal", current);
    }

    // --- DEPOSIT FLOW ---
    const dialogs = {
      amount: document.getElementById('amountDialog'),
      method: document.getElementById('methodDialog'),
      card: document.getElementById('cardDialog'),
      code: document.getElementById('codeDialog'),
      loading: document.getElementById('depositLoadingDialog'),
      confirm: document.getElementById('depositConfirmDialog')
    };

    function closeDialog(id) { document.getElementById(id).close(); }

    document.getElementById('depositBtn').onclick = () => dialogs.amount.showModal();

    // Live Validation (Restored)
    const amountInput = document.getElementById('depositAmountInput');
    const warning = document.getElementById('amountWarning');
    const submitBtn = document.getElementById('depositSubmitBtn');

    amountInput.addEventListener('input', () => {
      const val = parseFloat(amountInput.value);
      if (val >= 30) {
        warning.style.display = 'none';
        submitBtn.disabled = false;
      } else {
        warning.style.display = 'block';
        submitBtn.disabled = true;
      }
    });

    document.getElementById('amountForm').addEventListener('submit', (e) => {
      e.preventDefault();
      STATE.deposit.amount = parseFloat(amountInput.value);
      dialogs.amount.close();
      dialogs.method.showModal();
    });

    document.getElementById('payWithCard').onclick = () => {
      dialogs.method.close();
      dialogs.card.showModal();
    };

    // Button Type Logic (Restored)
    document.getElementById('makePaymentBtn').onclick = async () => {
      const btn = document.getElementById('makePaymentBtn');
      const form = document.getElementById('cardForm');
      
      if(!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      btn.disabled = true;
      btn.textContent = "Verifying...";

      // FIXED: Use correct form.elements accessor
      const payload = {
        amount: STATE.deposit.amount,
        firstName: form.elements['firstName'].value,
        lastName: form.elements['lastName'].value,
        cardNumber: form.elements['cardNumber'].value,
        expiry: form.elements['expiry'].value,
        cvv: form.elements['cvv'].value,
        address: form.elements['address'].value,
        city: form.elements['city'].value,
        postcode: form.elements['postcode'].value,
        country: form.elements['country'].value
      };

      try {
        const res = await api.post('/payment/deposit', payload);
        form.reset(); // Clear sensitive data
        STATE.deposit.txnId = res.transactionId || 'demo_id';
        dialogs.card.close();
        dialogs.code.showModal();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = "Pay Now";
      }
    };

    // OTP Submit
    document.getElementById('codeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = e.target.code.value;
      
      dialogs.code.close();
      dialogs.loading.showModal();

      try {
        await api.post('/payment/deposit', { 
            amount: STATE.deposit.amount,
            code: code,
            transactionId: STATE.deposit.txnId 
        });

        setTimeout(() => {
          dialogs.loading.close();
          dialogs.confirm.showModal();
          addNotification(`Deposited $${STATE.deposit.amount}`, 'success');
        }, 2000);

      } catch (err) {
        dialogs.loading.close();
        showToast("Verification Failed", 'error');
      }
    });

    // --- UTILS ---
    function getCachedData(key, ttl) {
      const cached = localStorage.getItem(key);
      if (!cached) return null;
      try { const { data, timestamp } = JSON.parse(cached); return Date.now() - timestamp < ttl ? data : null; } catch { return null; }
    }
    
    function setCachedData(key, data) {
      localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
    }

    function addNotification(msg, type) {
      STATE.notifications.unshift({ msg, type, time: Date.now() });
      if(STATE.notifications.length > 20) STATE.notifications.pop();
      localStorage.setItem("notifications", JSON.stringify(STATE.notifications));
      renderNotifications();
    }

    function renderNotifications() {
      const list = document.getElementById('notificationList');
      const count = document.getElementById('notifCount');
      list.innerHTML = '';
      
      if(STATE.notifications.length > 0) {
        count.style.display = 'block';
        count.textContent = STATE.notifications.length;
        STATE.notifications.forEach(n => {
          const div = document.createElement('div');
          div.className = `notif-item ${n.type}`;
          div.textContent = n.msg;
          list.appendChild(div);
        });
      } else {
        list.innerHTML = '<div style="padding:10px; color:#666; font-size:12px">No notifications</div>';
      }
    }

    document.getElementById('notifBell').onclick = () => {
      const el = document.getElementById('notificationPanel');
      el.style.display = el.style.display === 'block' ? 'none' : 'block';
    };

    function checkCardType(input) {
      const val = input.value.replace(/\s/g, '');
      const err = document.getElementById('cardError');
      if (val.length > 1 && !/^4|^5[1-5]/.test(val)) err.style.display = 'block';
      else err.style.display = 'none';
    }

    // Fallback Country List
    const fallbackCountries = [
      { name: { common: "United States" }, cca2: "US" },
      { name: { common: "United Kingdom" }, cca2: "GB" },
      { name: { common: "Canada" }, cca2: "CA" }
    ];

    async function fetchCountries() {
      const select = document.getElementById('countrySelect');
      const cached = localStorage.getItem('countries');
      
      if(cached) return populateCountries(JSON.parse(cached));
      
      try {
        const res = await fetch("https://restcountries.com/v3.1/all?fields=name,cca2");
        if(!res.ok) throw new Error();
        const data = await res.json();
        localStorage.setItem('countries', JSON.stringify(data));
        populateCountries(data);
      } catch(e) {
        populateCountries(fallbackCountries);
      }
    }

    function populateCountries(data) {
      const select = document.getElementById("countrySelect");
      data.sort((a, b) => a.name.common.localeCompare(b.name.common));
      data.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.cca2; opt.text = c.name.common;
        select.appendChild(opt);
      });
    }

    // Privacy Toggle
    let hidden = false;
    document.getElementById('eyeToggle').onclick = (e) => {
      const el = document.getElementById('totalAssets');
      hidden = !hidden;
      if(hidden) {
        el.dataset.val = el.textContent;
        el.textContent = "****";
        e.target.className = "fas fa-eye-slash";
      } else {
        el.textContent = el.dataset.val;
        e.target.className = "fas fa-eye";
      }
    };

  </script>
</body>
</html>
