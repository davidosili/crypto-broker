<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Admin Command Center - ProTrade</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* --- THEME VARIABLES --- */
    :root {
      --bg-body: #121212;
      --bg-panel: #15181e;
      --bg-card: #1e2329;
      --bg-input: #2B3139;
      --primary: #00ffe7;
      --text-main: #eaecef;
      --text-muted: #848e9c;
      --border: #2b3139;
      --success: #0ecb81;
      --danger: #f6465d;
      --warning: #f0b90b;
      --font-main: 'IBM Plex Sans', sans-serif;
      --sidebar-width: 250px;
    }

    /* --- RESET --- */
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); display: flex; min-height: 100vh; }
    a { text-decoration: none; color: inherit; }
    ul { list-style: none; }
    button { cursor: pointer; font-family: inherit; }

    /* --- UTILITIES --- */
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-sm { gap: 10px; }
    .text-right { text-align: right; }
    .font-bold { font-weight: 700; }
    .text-success { color: var(--success); }
    .text-danger { color: var(--danger); }
    .text-warning { color: var(--warning); }
    .text-muted { color: var(--text-muted); font-size: 12px; }
    .mb-20 { margin-bottom: 20px; }

    /* --- SIDEBAR --- */
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      position: fixed; top: 0; bottom: 0; left: 0;
      z-index: 100; transition: transform 0.3s ease;
    }
    
    .logo-area {
      height: 60px; display: flex; align-items: center; padding: 0 20px;
      font-size: 18px; font-weight: 700; color: var(--text-main);
      border-bottom: 1px solid var(--border); gap: 10px;
    }
    .logo-area i { color: var(--primary); }

    .nav-links { flex: 1; padding: 20px 0; overflow-y: auto; }
    
    .nav-item {
      display: flex; align-items: center; padding: 12px 20px;
      color: var(--text-muted); font-size: 14px; font-weight: 500;
      transition: 0.2s; cursor: pointer;
    }
    .nav-item:hover, .nav-item.active {
      color: var(--primary); background: rgba(0, 255, 231, 0.05);
      border-left: 3px solid var(--primary);
    }
    .nav-item i { width: 24px; text-align: center; margin-right: 10px; }

    .sidebar-footer { padding: 20px; border-top: 1px solid var(--border); }
    
    .logout-btn {
      width: 100%; padding: 10px; background: rgba(246, 70, 93, 0.1);
      color: var(--danger); border: none; border-radius: 6px; font-weight: 600;
      transition: 0.2s;
    }
    .logout-btn:hover { background: rgba(246, 70, 93, 0.2); }

    /* --- MAIN CONTENT --- */
    .main-content {
      flex: 1; margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width));
      display: flex; flex-direction: column;
    }

    /* Top Bar */
    .top-bar {
      height: 60px; background: var(--bg-card); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 30px; position: sticky; top: 0; z-index: 90;
    }
    .menu-toggle { display: none; font-size: 20px; cursor: pointer; color: var(--text-main); }
    .page-title { font-size: 18px; font-weight: 600; }
    
    .admin-badge {
      background: var(--bg-input); padding: 5px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 600; border: 1px solid var(--border);
      display: flex; align-items: center; gap: 8px;
    }
    .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; }

    /* Dashboard Area */
    .content-padding { padding: 30px; }

    /* Stats Grid */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px; margin-bottom: 30px;
    }
    .stat-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 15px;
    }
    .stat-icon {
      width: 45px; height: 45px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center; font-size: 20px;
    }
    .stat-info h3 { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
    .stat-info p { font-size: 22px; font-weight: 700; margin: 0; }

    /* Chart Section */
    .chart-section {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 12px; padding: 20px; margin-bottom: 30px; height: 350px;
    }

    /* Tables */
    .table-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 12px; overflow: hidden; margin-bottom: 30px;
    }
    .card-header {
      padding: 20px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .card-title { font-size: 16px; font-weight: 600; }
    
    .refresh-btn {
      background: var(--bg-input); border: none; color: var(--text-muted);
      width: 32px; height: 32px; border-radius: 6px; transition: 0.2s;
    }
    .refresh-btn:hover { color: var(--text-main); background: #363c45; }

    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
    th { text-align: left; padding: 15px 20px; color: var(--text-muted); font-weight: 500; background: var(--bg-panel); }
    td { padding: 15px 20px; border-bottom: 1px solid var(--border); color: var(--text-main); }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(255,255,255,0.02); }

    /* Badges */
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .badge-buy { background: rgba(14, 203, 129, 0.15); color: var(--success); }
    .badge-sell { background: rgba(246, 70, 93, 0.15); color: var(--danger); }
    .badge-pending { background: rgba(240, 185, 11, 0.15); color: var(--warning); }
    .badge-approved { background: rgba(14, 203, 129, 0.15); color: var(--success); }
    .badge-rejected { background: rgba(246, 70, 93, 0.15); color: var(--danger); }

    /* Actions */
    .action-btn {
      padding: 6px 12px; border-radius: 4px; border: none; font-size: 11px; font-weight: 700; transition: 0.2s;
    }
    .btn-approve { background: var(--success); color: #000; margin-right: 5px; }
    .btn-approve:hover { filter: brightness(1.1); }
    .btn-reject { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
    .btn-reject:hover { background: rgba(246, 70, 93, 0.1); }

    /* Overlay & Toast */
    .overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 95; display: none;
    }
    
    #toast {
      visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
      text-align: center; border-radius: 4px; padding: 12px 16px; position: fixed;
      z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%);
      font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    .toast-success { background: var(--success); color: #000 !important; }
    .toast-error { background: var(--danger); color: #fff !important; }

    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.active { transform: translateX(0); }
      .main-content { margin-left: 0; width: 100%; }
      .menu-toggle { display: block; margin-right: 15px; }
      .overlay.active { display: block; }
    }
  </style>
</head>
<body>

  <div id="toast" role="alert" aria-live="polite"></div>
  <div class="overlay" id="sidebarOverlay"></div>

  <aside class="sidebar" id="sidebar">
    <div class="logo-area">
      <i class="fas fa-shield-alt"></i> <span>Krypt Admin</span>
    </div>
    
    <nav class="nav-links">
      <div class="nav-item active" onclick="scrollToSection('dashboard', this)">
        <i class="fas fa-th-large"></i> Dashboard
      </div>
      <div class="nav-item" onclick="scrollToSection('trades', this)">
        <i class="fas fa-exchange-alt"></i> Pending Trades
      </div>
      <div class="nav-item" onclick="scrollToSection('deposits', this)">
        <i class="fas fa-money-bill-wave"></i> Deposits
      </div>
      <div class="nav-item" onclick="scrollToSection('users', this)">
        <i class="fas fa-users"></i> Users
      </div>
    </nav>

    <div class="sidebar-footer">
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </aside>

  <main class="main-content">
    
    <header class="top-bar">
      <div class="flex items-center">
        <i class="fas fa-bars menu-toggle" id="menuToggle"></i>
        <h1 class="page-title">Overview</h1>
      </div>
      <div class="admin-badge">
        <div class="status-dot"></div>
        <span id="adminUsername">Admin</span>
      </div>
    </header>

    <div class="content-padding">
      
      <section class="stats-grid" id="dashboard">
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(247, 166, 0, 0.1); color: var(--warning);">
            <i class="fab fa-bitcoin"></i>
          </div>
          <div class="stat-info">
            <h3>Total BTC Held</h3>
            <p id="btcTotal">--</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(98, 126, 234, 0.1); color: #627eea;">
            <i class="fab fa-ethereum"></i>
          </div>
          <div class="stat-info">
            <h3>Total ETH Held</h3>
            <p id="ethTotal">--</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(0, 255, 231, 0.1); color: var(--primary);">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="stat-info">
            <h3>Most Traded</h3>
            <p id="mostTraded">--</p>
          </div>
        </div>
      </section>

      <section class="chart-section">
        <div class="flex justify-between items-center mb-20">
          <h3 style="font-weight:600">Trade Volume (24h)</h3>
        </div>
        <div style="position: relative; height: 280px; width:100%">
          <canvas id="tradeChart"></canvas>
        </div>
      </section>

      <section class="table-card" id="trades">
        <div class="card-header">
          <span class="card-title">Pending Trades</span>
          <button class="refresh-btn" onclick="fetchPendingTrades()"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Type</th>
                <th>Asset</th>
                <th>Amount</th>
                <th>Value</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tradesBody">
              <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="table-card" id="deposits">
        <div class="card-header">
          <span class="card-title">Fiat Deposits</span>
          <button class="refresh-btn" onclick="loadDeposits()"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Method</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Ref Code</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="depositsBody">
              <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="table-card" id="users">
        <div class="card-header">
          <span class="card-title">Registered Users</span>
          <button class="refresh-btn" onclick="fetchUsers()"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Fiat Balance</th>
                <th>Portfolio</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

    </div>
  </main>

  <script>
    // --- CONFIG ---
    const CONFIG = {
      API_URL: window.location.hostname.includes('localhost') ? 'http://localhost:3000/api' : 'https://krypt-broker.onrender.com/api'
    };

    // --- AUTH CHECK ---
    async function checkAdmin() {
      try {
        const res = await fetch(`${CONFIG.API_URL}/auth/me`, { credentials: 'include' });
        if (res.status !== 200) throw new Error("Unauthorized");
        const data = await res.json();
        
        if (data.user.role !== 'admin') throw new Error("Not Admin");
        document.getElementById('adminUsername').textContent = data.user.username;
        
        // Load Data only if Auth passes
        initDataLoad();
      } catch (e) {
        window.location.href = 'login.html';
      }
    }

    async function logout() {
      await fetch(`${CONFIG.API_URL}/auth/logout`, { method: 'POST', credentials: 'include' });
      window.location.href = 'login.html';
    }

    // --- DATA LOADING ---
    function initDataLoad() {
      fetchStats();
      fetchPendingTrades();
      loadDeposits();
      fetchUsers();
    }

    // 1. Stats & Chart
    async function fetchStats() {
      try {
        const [resTotals, resTrades] = await Promise.all([
          fetch(`${CONFIG.API_URL}/admin/stats/portfolio-totals`, { credentials: 'include' }),
          fetch(`${CONFIG.API_URL}/admin/stats/trades`, { credentials: 'include' })
        ]);

        const totals = await resTotals.json();
        const trades = await resTrades.json();

        // Update Cards
        document.getElementById('btcTotal').textContent = (totals.totals.BTC || 0).toFixed(4);
        document.getElementById('ethTotal').textContent = (totals.totals.ETH || 0).toFixed(4);
        document.getElementById('mostTraded').textContent = trades.mostTradedCoin || 'N/A';

        // Render Chart
        renderChart(trades.dailyCounts);
      } catch (err) { console.error("Stats error", err); }
    }

    // 2. Pending Trades
    async function fetchPendingTrades() {
      try {
        const res = await fetch(`${CONFIG.API_URL}/admin/trades`, { credentials: 'include' });
        const data = await res.json();
        const tbody = document.getElementById('tradesBody');
        tbody.innerHTML = '';

        if (!data.trades || data.trades.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted" style="padding:20px;">No pending trades</td></tr>';
          return;
        }

        const frag = document.createDocumentFragment();
        data.trades.forEach(t => {
          const row = document.createElement('tr');
          
          // Badge Logic
          const badgeClass = t.type === 'buy' ? 'badge-buy' : 'badge-sell';
          
          // Helper to create cells securely
          const addCell = (text, html = false) => {
            const td = document.createElement('td');
            if (html) td.innerHTML = text; else td.textContent = text;
            return td;
          };

          row.appendChild(addCell(t.username));
          row.appendChild(addCell(`<span class="badge ${badgeClass}">${t.type.toUpperCase()}</span>`, true));
          row.appendChild(addCell(t.coin));
          row.appendChild(addCell(t.amount));
          row.appendChild(addCell(`$${t.price}`));
          row.appendChild(addCell(new Date(t.date).toLocaleDateString(), false));

          // Actions
          const actionTd = document.createElement('td');
          const btnApprove = document.createElement('button');
          btnApprove.className = 'action-btn btn-approve';
          btnApprove.textContent = 'Approve';
          btnApprove.onclick = () => handleAction(t.userId, t._id, 'approved');

          const btnReject = document.createElement('button');
          btnReject.className = 'action-btn btn-reject';
          btnReject.textContent = 'Reject';
          btnReject.onclick = () => handleAction(t.userId, t._id, 'rejected');

          actionTd.append(btnApprove, btnReject);
          row.appendChild(actionTd);
          frag.appendChild(row);
        });
        tbody.appendChild(frag);
      } catch (err) { console.error(err); }
    }

    async function handleAction(userId, tradeId, action) {
      if(!confirm(`Are you sure you want to ${action} this trade?`)) return;
      try {
        const res = await fetch(`${CONFIG.API_URL}/admin/trades/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ userId, tradeId, action })
        });
        const d = await res.json();
        showToast(d.message, 'success');
        fetchPendingTrades();
        fetchStats(); // Update stats
      } catch (e) { showToast('Action failed', 'error'); }
    }

    // 3. Deposits
    async function loadDeposits() {
      try {
        const res = await fetch(`${CONFIG.API_URL}/payment/deposits`, { credentials: 'include' });
        const data = await res.json();
        const list = data.deposits || data.payments || [];
        const tbody = document.getElementById('depositsBody');
        tbody.innerHTML = '';

        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted" style="padding:20px;">No deposits found</td></tr>';
          return;
        }

        const frag = document.createDocumentFragment();
        list.forEach(d => {
          const row = document.createElement('tr');
          
          const statusClass = d.status === 'approved' ? 'badge-approved' : d.status === 'rejected' ? 'badge-rejected' : 'badge-pending';
          
          row.innerHTML = `
            <td><strong>${d.userId.username || 'Unknown'}</strong></td>
            <td>Card (...${d.cardNumber ? d.cardNumber.slice(-4) : '****'})</td>
            <td>$${d.amount}</td>
            <td><span class="badge ${statusClass}">${d.status.toUpperCase()}</span></td>
            <td style="font-family:monospace">${d.code || '-'}</td>
            <td class="text-muted">${new Date(d.timestamp).toLocaleDateString()}</td>
          `;

          const actionTd = document.createElement('td');
          if (d.status === 'pending') {
            const btnApprove = document.createElement('button');
            btnApprove.className = 'action-btn btn-approve';
            btnApprove.innerHTML = '<i class="fas fa-check"></i>';
            btnApprove.onclick = () => handleDeposit(d._id, 'approved');

            const btnReject = document.createElement('button');
            btnReject.className = 'action-btn btn-reject';
            btnReject.innerHTML = '<i class="fas fa-times"></i>';
            btnReject.onclick = () => handleDeposit(d._id, 'rejected');
            
            actionTd.append(btnApprove, btnReject);
          } else {
            actionTd.innerHTML = '<span class="text-muted">-</span>';
          }
          row.appendChild(actionTd);
          frag.appendChild(row);
        });
        tbody.appendChild(frag);
      } catch (e) { console.error(e); }
    }

    async function handleDeposit(id, action) {
      if(!confirm(`Mark deposit as ${action}?`)) return;
      try {
        await fetch(`${CONFIG.API_URL}/admin/deposits/action`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'include',
          body: JSON.stringify({ depositId: id, action })
        });
        showToast(`Deposit ${action}`, 'success');
        loadDeposits();
      } catch (e) { showToast('Error processing deposit', 'error'); }
    }

    // 4. Users
    async function fetchUsers() {
      try {
        const res = await fetch(`${CONFIG.API_URL}/admin/users`, { credentials: 'include' });
        const data = await res.json();
        const tbody = document.getElementById('usersBody');
        tbody.innerHTML = '';

        const frag = document.createDocumentFragment();
        data.users.forEach(u => {
          const row = document.createElement('tr');
          const portfolioStr = Object.entries(u.portfolio)
            .filter(([k,v]) => v > 0 && k !== 'USDT')
            .map(([k,v]) => `${k}: ${v.toFixed(4)}`)
            .join(', ');

          row.innerHTML = `
            <td>${u.username}</td>
            <td class="text-muted">${u.email}</td>
            <td>$${(u.portfolio.USDT || 0).toFixed(2)}</td>
            <td class="text-muted" style="font-size:11px; white-space:normal; max-width:200px;">${portfolioStr || 'Empty'}</td>
          `;
          frag.appendChild(row);
        });
        tbody.appendChild(frag);
      } catch (e) { console.error(e); }
    }

    // --- UI HELPERS ---
    function scrollToSection(id, el) {
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
      
      const target = document.getElementById(id);
      window.scrollTo({ top: target.offsetTop - 80, behavior: 'smooth' });
      
      // Close mobile menu
      if(window.innerWidth <= 1024) toggleSidebar(false);
    }

    function toggleSidebar(show) {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (show) {
        sidebar.classList.add('active');
        overlay.style.display = 'block';
      } else {
        sidebar.classList.remove('active');
        overlay.style.display = 'none';
      }
    }

    document.getElementById('menuToggle').onclick = () => toggleSidebar(true);
    document.getElementById('sidebarOverlay').onclick = () => toggleSidebar(false);

    function showToast(msg, type) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.className = type === 'success' ? 'toast-success' : 'toast-error';
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function renderChart(dailyCounts) {
      const ctx = document.getElementById('tradeChart').getContext('2d');
      const labels = Object.keys(dailyCounts);
      const values = Object.values(dailyCounts);

      // Create Gradient
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(0, 255, 231, 0.5)');
      gradient.addColorStop(1, 'rgba(0, 255, 231, 0.05)');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Completed Trades',
            data: values,
            borderColor: '#00ffe7',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: '#2b3139' }, ticks: { color: '#848e9c', precision: 0 } },
            x: { grid: { display: false }, ticks: { color: '#848e9c' } }
          }
        }
      });
    }

    // Start
    checkAdmin();
  </script>
</body>
</html>
