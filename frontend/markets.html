<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Markets - ProTrade</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
    :root {
      --bg-body: #121212;
      --bg-card: #1E2329;
      --bg-input: #2B3139;
      --border-color: #2B3139;
      --primary-yellow: #F7A600;
      --text-primary: #EAECEF;
      --text-secondary: #848E9C;
      --success-green: #2EBD85;
      --danger-red: #F6465D;
      --font-main: 'IBM Plex Sans', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-primary); padding-bottom: 80px; }
    
    /* --- HEADER --- */
    .market-header {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--bg-card); height: 50px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; z-index: 1000; border-bottom: 1px solid var(--border-color);
    }
    .market-header h2 { font-size: 18px; font-weight: 600; }
    .search-btn { color: var(--text-primary); font-size: 18px; cursor: pointer; }

    /* --- CATEGORY TABS --- */
    .tabs-wrapper {
      margin-top: 50px;
      background: var(--bg-body);
      padding: 10px 16px;
      position: sticky; top: 50px; z-index: 900;
    }
    .tabs-scroll {
      display: flex; gap: 20px; overflow-x: auto; scrollbar-width: none;
    }
    .tab-item {
      font-size: 14px; color: var(--text-secondary); white-space: nowrap; font-weight: 500; cursor: pointer; position: relative; padding-bottom: 8px;
    }
    .tab-item.active { color: var(--text-primary); font-weight: 700; }
    .tab-item.active::after {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0;
      height: 3px; background: var(--primary-yellow); border-radius: 2px;
    }

    /* --- MARKET OVERVIEW --- */
    .overview-card {
      margin: 10px 16px; padding: 16px;
      background: var(--bg-card); border-radius: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .sentiment-box div:first-child { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .sentiment-text { font-size: 16px; font-weight: 700; }
    
    .sentiment-bars { display: flex; gap: 2px; height: 4px; width: 60px; margin-top: 5px; }
    .bar { flex: 1; background: var(--bg-input); border-radius: 2px; }
    .bar.fill-green { background: var(--success-green); }
    .bar.fill-red { background: var(--danger-red); }

    /* --- COIN LIST --- */
    .list-header {
      display: flex; justify-content: space-between; padding: 10px 16px;
      font-size: 12px; color: var(--text-secondary);
    }
    .coin-list { padding: 0 16px; }
    
    .coin-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 0; border-bottom: 1px solid var(--border-color); cursor: pointer;
    }
    
    .col-fav { width: 30px; text-align: left; }
    .col-name { flex: 2; display: flex; align-items: center; gap: 10px; }
    .col-price { flex: 1.5; text-align: right; font-weight: 600; font-size: 15px; }
    .col-change { flex: 1.2; text-align: right; }

    .change-btn {
      display: inline-block; padding: 6px 0; width: 70px; text-align: center;
      border-radius: 4px; color: #fff; font-size: 13px; font-weight: 600;
    }
    .bg-green { background: var(--success-green); }
    .bg-red { background: var(--danger-red); }

    .coin-symbol { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .coin-vol { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
    .coin-icon { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
    
    /* Favorite Star */
    .fav-star { font-size: 14px; color: var(--bg-input); transition: color 0.2s; }
    .fav-star.active { color: var(--primary-yellow); }

    /* --- SKELETON LOADER --- */
    .skeleton {
      background: linear-gradient(90deg, #1E2329 25%, #2B3139 50%, #1E2329 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* --- BOTTOM NAV --- */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
      background: var(--bg-card); border-top: 1px solid var(--border-color);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 1000; padding-bottom: 5px;
    }
    .bottom-nav a {
      display: flex; flex-direction: column; align-items: center;
      color: var(--text-secondary); font-size: 10px; gap: 6px; width: 25%;
    }
    .bottom-nav a.active { color: var(--primary-yellow); }
    .bottom-nav i { font-size: 20px; }

    /* --- SEARCH MODAL --- */
    #searchOverlay {
      position: fixed; top: 0; left: 0; right: 0; height: 100%;
      background: var(--bg-body); z-index: 2000; padding: 16px;
      display: none;
    }
    .search-input-wrapper {
      display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
    }
    .search-input-wrapper input {
      flex: 1; background: var(--bg-input); border: none; padding: 12px;
      border-radius: 4px; color: white; font-size: 16px;
    }
    .close-search { color: var(--primary-yellow); font-weight: 600; cursor: pointer; }

  </style>
</head>
<body>

  <header class="market-header">
    <h2>Markets</h2>
    <i class="fas fa-search search-btn" onclick="toggleSearch(true)"></i>
  </header>

  <div class="tabs-wrapper">
    <div class="tabs-scroll">
      <div class="tab-item active" onclick="filterCoins('all', this)">All</div>
      <div class="tab-item" onclick="filterCoins('favorites', this)">Favorites</div>
      <div class="tab-item" onclick="filterCoins('gainers', this)">Top Gainers</div>
      <div class="tab-item" onclick="filterCoins('losers', this)">Top Losers</div>
    </div>
  </div>

  <div class="overview-card">
    <div class="sentiment-box">
      <div>Market Sentiment</div>
      <div class="sentiment-text" id="sentimentText">Neutral</div>
      <div class="sentiment-bars" id="sentimentBars">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
    </div>
    <div style="text-align: right;">
      <div style="font-size: 12px; color: var(--text-secondary);">24h Vol</div>
      <div style="font-weight: 600;">$42.8B</div>
    </div>
  </div>

  <div class="list-header">
    <span class="col-fav"></span>
    <span style="flex:2">Name / Vol</span>
    <span style="flex:1.5; text-align: right;">Last Price</span>
    <span style="flex:1.2; text-align: right;">24h Chg%</span>
  </div>

  <div class="coin-list" id="coinList">
    <div class="coin-row"><div class="skeleton" style="width: 100%; height: 40px;"></div></div>
    <div class="coin-row"><div class="skeleton" style="width: 100%; height: 40px;"></div></div>
    <div class="coin-row"><div class="skeleton" style="width: 100%; height: 40px;"></div></div>
    <div class="coin-row"><div class="skeleton" style="width: 100%; height: 40px;"></div></div>
    <div class="coin-row"><div class="skeleton" style="width: 100%; height: 40px;"></div></div>
  </div>

  <nav class="bottom-nav">
    <a href="dashboard.html">
      <i class="fas fa-home"></i><span>Home</span>
    </a>
    <a href="markets.html" class="active">
      <i class="fas fa-chart-bar"></i><span>Markets</span>
    </a>
    <a href="trade.html">
      <i class="fas fa-exchange-alt"></i><span>Trade</span>
    </a>
    <a href="assets.html">
      <i class="fas fa-wallet"></i><span>Assets</span>
    </a>
  </nav>

  <div id="searchOverlay">
    <div class="search-input-wrapper">
      <i class="fas fa-search" style="color: var(--text-secondary)"></i>
      <input type="text" id="marketSearch" placeholder="Search coin (e.g. BTC)" autocomplete="off" aria-label="Search Cryptocurrency">
      <span class="close-search" onclick="toggleSearch(false)">Cancel</span>
    </div>
    <div class="coin-list" id="searchResults"></div>
  </div>

  <script>
    const API_URL = location.hostname.includes('localhost') || location.hostname.includes('127.')
      ? 'http://localhost:3000/api'
      : 'https://krypt-broker.onrender.com/api';

    let allCoins = [];
    let favorites = new Set(JSON.parse(localStorage.getItem('favCoins') || '[]'));

    // --- 1. Fetch & Cache Logic ---
    async function loadMarkets() {
      try {
        let data = getCachedData('marketData');
        if (!data) {
          const res = await fetch(`${API_URL}/coin/markets`);
          if (!res.ok) throw new Error(`API Error: ${res.status}`);
          data = await res.json();
          setCachedData('marketData', data);
        }
        
        // üîß Optimization: Precompute search string
        allCoins = data.map(c => ({
          ...c,
          _searchStr: (c.name + c.symbol).toLowerCase()
        }));

        updateSentiment(data);
        renderList(allCoins); 
      } catch (err) {
        console.error("Failed to load markets", err);
        document.getElementById('coinList').innerHTML = '<div style="text-align:center; padding:20px; color:var(--danger-red)">Failed to load market data.</div>';
      }
    }

    // --- 2. Render List Logic ---
    function renderList(coinsToRender) {
      const container = document.getElementById('coinList');
      container.innerHTML = '';

      if(!coinsToRender || coinsToRender.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary)">No coins found</div>';
        return;
      }

      coinsToRender.forEach(c => {
        const change = typeof c.price_change_percentage_24h === 'number' ? c.price_change_percentage_24h : 0;
        const isPos = change >= 0;
        const colorClass = isPos ? 'bg-green' : 'bg-red';
        const sign = isPos ? '+' : '';
        const isFav = favorites.has(c.id);

        const div = document.createElement('div');
        div.className = 'coin-row';
        div.onclick = (e) => {
            if(e.target.classList.contains('fav-star')) return; // Prevent nav if clicking star
            window.location.href = `coin.html?coinId=${c.id}`;
        };
        
        div.innerHTML = `
          <div class="col-fav">
            <i class="fas fa-star fav-star ${isFav ? 'active' : ''}" onclick="toggleFavorite('${c.id}', this)"></i>
          </div>
          <div class="col-name">
            <img src="${c.image}" class="coin-icon" alt="${c.name} Logo">
            <div>
              <div class="coin-symbol">${c.symbol.toUpperCase()}</div>
              <div class="coin-vol">Vol ${formatVolume(c.total_volume)}</div>
            </div>
          </div>
          <div class="col-price">$${c.current_price.toLocaleString()}</div>
          <div class="col-change">
            <span class="change-btn ${colorClass}">${sign}${change.toFixed(2)}%</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // --- 3. Favorites Logic ---
    function toggleFavorite(coinId, el) {
      if (favorites.has(coinId)) {
        favorites.delete(coinId);
        el.classList.remove('active');
      } else {
        favorites.add(coinId);
        el.classList.add('active');
      }
      localStorage.setItem('favCoins', JSON.stringify([...favorites]));
    }

    // --- 4. Filtering Logic ---
    function filterCoins(type, btn) {
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');

      let filtered = allCoins.slice(); // üõ°Ô∏è Safety: prevent mutation

      if (type === 'favorites') {
        filtered = filtered.filter(c => favorites.has(c.id));
      } else if (type === 'gainers') {
        filtered.sort((a, b) => (b.price_change_percentage_24h ?? 0) - (a.price_change_percentage_24h ?? 0));
      } else if (type === 'losers') {
        filtered.sort((a, b) => (a.price_change_percentage_24h ?? 0) - (b.price_change_percentage_24h ?? 0));
      }
      
      renderList(filtered);
    }

    // --- 5. Sentiment Logic ---
    function updateSentiment(coins) {
      if (!coins || coins.length === 0) return;

      const gainers = coins.filter(c => (c.price_change_percentage_24h ?? 0) > 0).length;
      const percent = (gainers / coins.length) * 100;
      
      const textEl = document.getElementById('sentimentText');
      const bars = document.getElementById('sentimentBars').children;

      Array.from(bars).forEach(b => b.className = 'bar');

      if (percent > 60) {
        textEl.textContent = "Bullish üêÇ";
        textEl.style.color = "var(--success-green)";
        bars[0].classList.add('fill-green');
        bars[1].classList.add('fill-green');
        bars[2].classList.add('fill-green');
      } else if (percent < 40) {
        textEl.textContent = "Bearish üêª";
        textEl.style.color = "var(--danger-red)";
        bars[0].classList.add('fill-red');
        bars[1].classList.add('fill-red');
        bars[2].classList.add('fill-red');
      } else {
        textEl.textContent = "Neutral ‚öñÔ∏è";
        textEl.style.color = "var(--text-primary)";
        bars[0].classList.add('fill-green');
        bars[1].classList.add('fill-green');
      }
    }

    // --- 6. Search Logic ---
    function toggleSearch(show) {
      const el = document.getElementById('searchOverlay');
      el.style.display = show ? 'block' : 'none';
      if(show) document.getElementById('marketSearch').focus();
    }

    let searchTimeout;

    document.getElementById('marketSearch').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.toLowerCase().trim();
      const resultsDiv = document.getElementById('searchResults');

      if (!query) {
        resultsDiv.innerHTML = '';
        return;
      }

      searchTimeout = setTimeout(() => {
        // üîß Optimization: Use precomputed _searchStr
        const matches = allCoins.filter(c => c._searchStr.includes(query));

        resultsDiv.innerHTML = ''; 
        
        matches.forEach(c => {
          const div = document.createElement('div');
          div.className = 'coin-row';
          div.onclick = () => window.location.href = `coin.html?coinId=${c.id}`;
          div.innerHTML = `
            <div class="col-name">
              <img src="${c.image}" class="coin-icon" alt="${c.name}">
              <div class="coin-symbol">${c.symbol.toUpperCase()}</div>
            </div>
            <div class="col-price">$${c.current_price.toLocaleString()}</div>
          `;
          resultsDiv.appendChild(div);
        });

        if(matches.length === 0) {
            resultsDiv.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary)">No matches found</div>';
        }
      }, 300);
    });

    // --- Helpers ---
    function formatVolume(num) {
      if(num >= 1000000000) return (num/1000000000).toFixed(2) + 'B';
      if(num >= 1000000) return (num/1000000).toFixed(2) + 'M';
      return num.toLocaleString();
    }

    function getCachedData(key, ttl = 60000) { 
      const cached = localStorage.getItem(key);
      if (!cached) return null;
      try { const { data, timestamp } = JSON.parse(cached); return Date.now() - timestamp < ttl ? data : null; } catch { return null; }
    }
    
    function setCachedData(key, data) {
      localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
    }

    document.addEventListener('DOMContentLoaded', loadMarkets);
  </script>
</body>
</html>
