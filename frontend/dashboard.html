<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ProTrade Dashboard</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
    /* --- THEME VARIABLES --- */
    :root {
      --bg-body: #121212;
      --bg-card: #1E2329;
      --bg-input: #2B3139;
      --border-color: #2B3139;
      --primary-yellow: #F7A600;
      --text-primary: #EAECEF;
      --text-secondary: #848E9C;
      --success-green: #2EBD85;
      --danger-red: #F6465D;
      --font-main: 'IBM Plex Sans', sans-serif;
      --sidebar-width: 260px; /* New Variable for desktop calculation */
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-primary); padding-bottom: 80px; }
    a { text-decoration: none; color: inherit; }
    ul { list-style: none; }

    /* --- LAYOUT COMPONENTS --- */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--bg-card); height: 60px;
      display: flex; align-items: center; padding: 0 20px;
      z-index: 1000; border-bottom: 1px solid var(--border-color); gap: 15px;
      transition: left 0.3s ease;
    }

    .menu-btn { font-size: 20px; color: var(--text-primary); cursor: pointer; padding: 5px; }

    .search-container { flex: 1; position: relative; max-width: 600px; }
    #coinSearch {
      width: 100%; background: var(--bg-input); border: 1px solid transparent;
      padding: 10px 12px 10px 40px; border-radius: 8px;
      color: var(--text-primary); font-size: 14px; transition: border 0.3s;
    }
    #coinSearch:focus { outline: none; border-color: var(--primary-yellow); }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 14px; }

    #searchResults {
      position: absolute; top: 45px; width: 100%; background: var(--bg-card);
      border: 1px solid var(--border-color); border-radius: 8px;
      max-height: 300px; overflow-y: auto; z-index: 1002;
      box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }
    #searchResults li { border-bottom: 1px solid var(--border-color); }
    #searchResults li a { display: flex; justify-content: space-between; padding: 12px; font-size: 14px; }
    #searchResults li:hover { background: var(--bg-input); }

    /* --- SIDEBAR --- */
    .sidebar {
      position: fixed; left: -280px; top: 0; height: 100%; width: 280px;
      background: var(--bg-card); z-index: 1100; transition: left 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.5); padding: 20px; display: flex; flex-direction: column;
      border-right: 1px solid var(--border-color);
    }
    .sidebar.active { left: 0; }
    
    .sidebar-header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
    .profile-icon { width: 45px; height: 45px; border-radius: 50%; background: var(--bg-input); padding: 2px; }
    
    .sidebar-menu ul li a { 
        display: flex; align-items: center; gap: 12px;
        padding: 14px 10px; border-radius: 8px; 
        color: var(--text-secondary); font-size: 14px; transition: 0.2s;
    }
    .sidebar-menu ul li a:hover { background: var(--bg-input); color: var(--text-primary); }
    .sidebar-menu ul li a i { width: 20px; text-align: center; }
    
    .sidebar-menu button { width: 100%; padding: 12px; background: rgba(246, 70, 93, 0.1); border: none; color: var(--danger-red); border-radius: 6px; margin-top: 20px; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .sidebar-menu button:hover { background: rgba(246, 70, 93, 0.2); }
    
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1050; display: none; }
    .overlay.active { display: block; }

    /* --- MAIN CONTENT --- */
    .content-wrapper { padding-top: 80px; padding-left: 16px; padding-right: 16px; max-width: 1200px; margin: 0 auto; transition: padding 0.3s; }

    .dashboard-grid { display: flex; flex-direction: column; gap: 16px; }

    .chart-card { background: var(--bg-card); border-radius: 12px; padding: 20px; height: 350px; position: relative; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
    .chart-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .chart-header span { font-size: 14px; color: var(--text-primary); font-weight: 600; }
    .canvas-container { flex: 1; position: relative; }

    .portfolio-card { background: linear-gradient(135deg, #2b3139 0%, #1e2329 100%); border-radius: 12px; padding: 24px; border: 1px solid var(--border-color); height: 100%; }
    .portfolio-header { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .total-value-display { font-size: 36px; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; letter-spacing: -0.5px; }
    .coin-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.05); }
    .coin-price { text-align: right; }

    /* --- TABS & LISTS --- */
    .action-tabs { display: flex; background: var(--bg-card); padding: 4px; border-radius: 8px; margin-bottom: 16px; gap: 4px; border: 1px solid var(--border-color); }
    .action-tabs button { flex: 1; background: transparent; border: none; color: var(--text-secondary); padding: 10px; font-size: 13px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .action-tabs button.active { background: var(--bg-input); color: var(--text-primary); }
    .action-tabs button.trade-btn { color: var(--primary-yellow); }
    .action-tabs button:hover { color: var(--text-primary); }

    .coin-list-container { background: var(--bg-card); border-radius: 12px; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border-color); }
    .coin-item { padding: 14px 20px; border-bottom: 1px solid var(--border-color); transition: background 0.2s; }
    .coin-item:hover { background: var(--bg-input); }
    .coin-item a { width: 100%; display: flex; justify-content: space-between; align-items: center; font-weight: 500; font-size: 14px; }

    /* --- GRID --- */
    .section-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    #trendingCoins, .coin-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px; }
    
    .coin-card { background: var(--bg-card); padding: 16px; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border-color); }
    .coin-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-color: var(--text-secondary); }
    .coin-card h4 { font-size: 14px; margin-bottom: 5px; color: var(--text-primary); font-weight: 600; }
    .coin-card .price { font-size: 16px; font-weight: 700; margin-bottom: 2px; color: var(--text-primary); }
    
    .text-green, .positive { color: var(--success-green); }
    .text-red, .negative { color: var(--danger-red); }

    /* --- BOTTOM NAV --- */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--bg-card); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: 5px; }
    .bottom-nav a { display: flex; flex-direction: column; align-items: center; color: var(--text-secondary); font-size: 10px; gap: 6px; width: 25%; transition: 0.2s; }
    .bottom-nav a:hover { color: var(--text-primary); }
    .bottom-nav a.active { color: var(--primary-yellow); }
    .bottom-nav i { font-size: 20px; }

    /* --- UTILS --- */
    iframe.card { border-radius: 12px; margin-bottom: 20px; background: var(--bg-card); border: 1px solid var(--border-color); }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--text-secondary); border-top-color: var(--primary-yellow); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* =========================================
       desktop-view.css - Responsive Overrides
       ========================================= */
    @media (min-width: 1024px) {
      /* Sidebar becomes permanent */
      .sidebar {
        left: 0 !important;
        width: var(--sidebar-width);
        box-shadow: none;
      }
      .menu-btn { display: none; } /* Hide hamburger */
      .overlay { display: none !important; }
      
      /* Top bar adjustment */
      .top-bar {
        left: var(--sidebar-width);
        width: calc(100% - var(--sidebar-width));
        padding: 0 40px;
      }

      /* Content adjustment */
      .content-wrapper {
        padding-left: calc(var(--sidebar-width) + 40px);
        padding-right: 40px;
        max-width: 1600px;
        padding-top: 90px;
      }

      /* Dashboard Grid Layout */
      .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr; /* Chart takes 2/3, Portfolio 1/3 */
        gap: 20px;
        height: auto;
      }
      
      .chart-card { height: 400px; margin-bottom: 0; }
      .portfolio-card { margin-bottom: 0; }

      /* Action Tabs */
      .action-tabs {
        max-width: 400px;
      }

      /* Trending Grid - 4 Columns */
      #trendingCoins, .coin-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }

      /* Lists Side-by-Side with News */
      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      /* Hide Mobile Bottom Nav */
      .bottom-nav { display: none; }
      body { padding-bottom: 0; }
    }
  </style>
</head>
<body>

  <div class="overlay" id="sidebarOverlay"></div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Profile" class="profile-icon">
      <div><h2 id="userInfo" style="font-size:16px;">Guest</h2><p style="font-size:12px; color:var(--text-secondary);">UID: 8839201</p></div>
    </div>
    <div class="sidebar-menu">
      <ul>
        <li><a href="dashboard.html" style="color:var(--primary-yellow); background:var(--bg-input);"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="markets.html"><i class="fas fa-chart-line"></i> Markets</a></li>
        <li><a href="trade.html"><i class="fas fa-exchange-alt"></i> Spot Trade</a></li>
        <li><a href="assets.html"><i class="fas fa-wallet"></i> Wallet</a></li>
        <li><a href="create-strategy.html"><i class="fas fa-robot"></i> Strategy Bot</a></li>
        <li><a href="security.html"><i class="fas fa-shield-alt"></i> Security</a></li>
        <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
      </ul>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </aside>

  <header class="top-bar">
    <div class="menu-btn" id="sidebarToggle"><i class="fas fa-bars"></i></div>
    <div class="search-container">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="coinSearch" placeholder="Search Coin (e.g. BTC)" aria-label="Search Cryptocurrency">
      <ul id="searchResults"></ul>
    </div>
  </header>

  <div class="content-wrapper">
    
    <div class="dashboard-grid">
      <div class="chart-card">
        <div class="chart-header">
          <span id="currentCoinLabel">BTC/USDT</span>
          <span style="cursor:pointer;" id="expandChartBtn"><i class="fas fa-expand-alt"></i></span>
        </div>
        <div class="canvas-container">
          <canvas id="coinChart"></canvas>
        </div>
      </div>

      <div class="portfolio-card">
        <div class="portfolio-header">Total Assets (USD) <i class="fas fa-eye" title="Toggle Balance Visibility"></i></div>
        <div class="total-value-display"><span id="totalValue">0.00</span></div>
        <div id="portfolioBreakdown">
          <div id="portfolioSpinner" style="text-align: center; margin: 1rem 0;">
            <div class="spinner"></div><p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Loading assets...</p>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top: 25px;"></div>

    <div class="action-tabs">
      <button class="active" onclick="toggleRising(this)">Gainers</button>
      <button onclick="toggleFalling(this)">Losers</button>
      <button class="trade-btn" onclick="window.location.href='trade.html'">Trade</button>
    </div>

    <div id="risingList" class="coin-list-container"></div>
    <div id="fallingList" class="coin-list-container" style="display: none;"></div>

    <section>
      <div class="section-title"><i class="fas fa-fire" style="color: #ff9800;"></i> Hot Derivatives</div>
      <div id="trendingCoins" class="coin-grid"></div>
    </section>

    <div class="section-title"><i class="fas fa-newspaper"></i> Latest News</div>
    <iframe class="card" width="100%" scrolling="no" frameborder="0" src="https://cryptopanic.com/widgets/news/?bg_color=1E2329&font_family=sans&header_bg_color=1E2329&header_text_color=FFFFFF&link_color=F7A600&news_feed=recent&text_color=EAECEF&title=Latest%20News" height="300px"></iframe>
  </div>

  <nav class="bottom-nav">
    <a href="dashboard.html" class="active"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="markets.html"><i class="fas fa-chart-bar"></i><span>Markets</span></a>
    <a href="trade.html"><i class="fas fa-exchange-alt"></i><span>Trade</span></a>
    <a href="assets.html"><i class="fas fa-wallet"></i><span>Assets</span></a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_URL = location.hostname.includes('localhost') || location.hostname.includes('127.') 
      ? 'http://localhost:3000/api' 
      : 'https://krypt-broker.onrender.com/api';
  
    // DOM Cache (Performance)
    const DOM = {
      sidebar: document.getElementById('sidebar'),
      overlay: document.getElementById('sidebarOverlay'),
      portfolioBreakdown: document.getElementById('portfolioBreakdown'),
      totalValue: document.getElementById('totalValue'),
      risingList: document.getElementById('risingList'),
      fallingList: document.getElementById('fallingList'),
      trendingCoins: document.getElementById('trendingCoins'),
      searchResults: document.getElementById('searchResults')
    };

    const STATE = {
      balanceVisible: true,
      portfolioData: null,
      totalValue: 0,
      marketData: []
    };
    
    let isChartLoading = false;
  
    // --- UI HELPERS ---
    function toggleSidebar(show) {
      if(show) { DOM.sidebar.classList.add('active'); DOM.overlay.classList.add('active'); }
      else { DOM.sidebar.classList.remove('active'); DOM.overlay.classList.remove('active'); }
    }
    
    document.getElementById('sidebarToggle').addEventListener('click', () => toggleSidebar(true));
    DOM.overlay.addEventListener('click', () => toggleSidebar(false));

    // CLICK OUTSIDE TO CLOSE SEARCH
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        DOM.searchResults.innerHTML = '';
      }
    });
  
    const eyeIcon = document.querySelector('.portfolio-header .fa-eye');
    if(eyeIcon) {
      eyeIcon.style.cursor = 'pointer';
      eyeIcon.addEventListener('click', () => {
        STATE.balanceVisible = !STATE.balanceVisible;
        eyeIcon.className = STATE.balanceVisible ? 'fas fa-eye' : 'fas fa-eye-slash';
        renderPortfolioValues();
      });
    }
  
    // FULLSCREEN CHART SUPPORT
    document.getElementById('expandChartBtn').addEventListener('click', () => {
      const chartCard = document.querySelector('.chart-card');
      if (!document.fullscreenElement && !document.webkitFullscreenElement) {
        if(chartCard.requestFullscreen) { chartCard.requestFullscreen(); }
        else if(chartCard.webkitRequestFullscreen) { chartCard.webkitRequestFullscreen(); } 
      } else {
        if(document.exitFullscreen) { document.exitFullscreen(); }
        else if(document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
      }
    });
  
    // TABS
    window.toggleRising = function(el) {
      DOM.risingList.style.display = 'block';
      DOM.fallingList.style.display = 'none';
      updateTabActiveState(el);
    };
  
    window.toggleFalling = function(el) {
      DOM.risingList.style.display = 'none';
      DOM.fallingList.style.display = 'block';
      updateTabActiveState(el);
    };
  
    function updateTabActiveState(activeBtn) {
      document.querySelectorAll('.action-tabs button').forEach(btn => {
        if(!btn.classList.contains('trade-btn')) btn.classList.remove('active');
      });
      activeBtn.classList.add('active');
    }
  
    // --- DATA LOGIC ---
    async function initApp() {
      await fetchUserInfo();
      await fetchMarketData(); 
      fetchPortfolio(); 
      updateChart();
      setInterval(updateChart, 15000); 
      setInterval(fetchMarketData, 30000);
    }
  
    async function fetchUserInfo() {
      try {
        const res = await fetch(`${API_URL}/auth/me`, { credentials: 'include' });
        if(!res.ok) throw new Error(res.status);
        const data = await res.json();
        if (data.user) document.getElementById('userInfo').textContent = data.user.username;
      } catch(e) { console.warn("Guest mode"); }
    }
  
    async function fetchMarketData() {
      if (document.hidden || !navigator.onLine) return;

      try {
        let data = getCachedData('coinMarkets', 30000);
        if (!data) {
          const res = await fetch(`${API_URL}/coin/markets`);
          if(!res.ok) throw new Error("Market Fetch Failed");
          data = await res.json();
          setCachedData('coinMarkets', data);
        }
        STATE.marketData = data;
        renderTrendingLists();
      } catch (err) { console.error("Market data unavailable"); }
    }
  
    async function fetchPortfolio() {
      if (!STATE.marketData || STATE.marketData.length === 0) {
        setTimeout(fetchPortfolio, 3000); 
        return;
      }

      try {
          const res = await fetch(`${API_URL}/trade/portfolio`, { credentials: 'include' });
          if(!res.ok) throw new Error("Portfolio Fetch Failed");
          const data = await res.json();
          STATE.portfolioData = data.portfolio || {};
          
          const marketMap = Object.fromEntries(STATE.marketData.map(c => [c.symbol.toLowerCase(), c]));
          
          let totalUSD = 0;
          Object.entries(STATE.portfolioData).forEach(([symbol, amount]) => {
              const coin = marketMap[symbol.toLowerCase()];
              if(coin) totalUSD += amount * coin.current_price;
          });
          
          STATE.totalValue = totalUSD;
          renderPortfolioValues();
      } catch (err) {
          DOM.portfolioBreakdown.innerHTML = '<div style="text-align:center; padding:15px; font-size:13px; color:var(--text-secondary);">Please <a href="login.html" style="color:var(--primary-yellow)">login</a> to view assets</div>';
      }
    }
  
    function renderPortfolioValues() {
      DOM.totalValue.textContent = STATE.balanceVisible 
        ? STATE.totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) 
        : '****';
  
      DOM.portfolioBreakdown.innerHTML = ''; 
      
      if (!STATE.portfolioData || Object.keys(STATE.portfolioData).length === 0) {
          DOM.portfolioBreakdown.innerHTML = '<p style="text-align:center; color:var(--text-secondary); font-size:12px; padding:10px;">No assets found</p>';
          return;
      }
  
      const marketMap = Object.fromEntries(STATE.marketData.map(c => [c.symbol.toLowerCase(), c]));

      Object.entries(STATE.portfolioData).forEach(([symbol, amount]) => {
          const coin = marketMap[symbol.toLowerCase()];
          const price = coin ? coin.current_price : 0;
          const value = amount * price;
          const img = coin ? coin.image : 'https://cdn-icons-png.flaticon.com/512/1213/1213791.png';
  
          const displayValue = STATE.balanceVisible ? `$${value.toLocaleString(undefined, {minimumFractionDigits: 2})}` : '****';
  
          const row = document.createElement('div');
          row.className = 'coin-row';
          row.innerHTML = `
            <div class="coin-info" style="display:flex; align-items:center; gap:10px;">
              <img src="${img}" style="width:28px; height:28px; border-radius:50%;">
              <div>
                <strong style="color:var(--text-primary); font-size:14px;">${symbol.toUpperCase()}</strong>
                <small style="color:var(--text-secondary); font-size:11px;">${amount.toFixed(4)}</small>
              </div>
            </div>
            <div class="coin-price">
              <strong style="color:var(--text-primary); font-size:14px;">${displayValue}</strong>
              <small style="display:block; color:var(--text-secondary); font-size:11px;">$${price.toLocaleString()}</small>
            </div>`;
            DOM.portfolioBreakdown.appendChild(row);
      });
    }
  
    function renderTrendingLists() {
      const coins = STATE.marketData;
      if(!coins || coins.length === 0) return;
  
      DOM.risingList.innerHTML = ''; 
      DOM.fallingList.innerHTML = ''; 
      DOM.trendingCoins.innerHTML = '';
  
      const rising = [...coins].sort((a, b) => b.price_change_percentage_24h - a.price_change_percentage_24h).slice(0, 5);
      const falling = [...coins].sort((a, b) => a.price_change_percentage_24h - b.price_change_percentage_24h).slice(0, 5);
  
      const createListItem = (c, colorClass) => {
          const change = c.price_change_percentage_24h ?? 0;
          const changeStr = (change > 0 ? '+' : '') + change.toFixed(2) + '%';
          
          const div = document.createElement('div');
          div.className = 'coin-item';
          div.innerHTML = `
              <a href="coin.html?coinId=${c.id}">
                  <div style="display:flex; align-items:center; gap:10px;">
                      <img src="${c.image}" style="width:24px; height:24px; border-radius:50%;">
                      <div style="display:flex; flex-direction:column;">
                          <span style="color:var(--text-primary); font-weight:600; font-size:13px;">${c.symbol.toUpperCase()}</span>
                          <span style="font-size:10px; color:var(--text-secondary)">Vol ${formatVolume(c.total_volume)}</span>
                      </div>
                  </div>
                  <div style="text-align:right;">
                      <div style="color:var(--text-primary); font-size:13px; font-weight:500;">$${c.current_price.toLocaleString()}</div>
                      <div class="${colorClass}" style="font-size:11px; font-weight:600;">${changeStr}</div>
                  </div>
              </a>`;
          return div;
      };
  
      rising.forEach(c => DOM.risingList.appendChild(createListItem(c, 'text-green')));
      falling.forEach(c => DOM.fallingList.appendChild(createListItem(c, 'text-red')));
  
      const volumeCoins = [...coins].sort((a,b) => b.total_volume - a.total_volume).slice(0, 4);
      volumeCoins.forEach(c => {
          const change = c.price_change_percentage_24h ?? 0;
          const changeClass = change >= 0 ? 'text-green' : 'text-red';
          const div = document.createElement('div');
          div.className = 'coin-card';
          div.onclick = () => window.location.href = `coin.html?coinId=${c.id}`;
          div.innerHTML = `
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                 <h4 style="font-size:13px;">${c.symbol.toUpperCase()}</h4>
                 <img src="${c.image}" style="width:15px; height:15px; border-radius:50%;">
              </div>
              <div class="price" style="font-size:15px;">$${c.current_price.toLocaleString()}</div>
              <div class="${changeClass}" style="font-size:11px;">${change.toFixed(2)}%</div>`;
          DOM.trendingCoins.appendChild(div);
      });
    }
  
    function formatVolume(num) {
      if(num >= 1000000000) return (num/1000000000).toFixed(2) + 'B';
      if(num >= 1000000) return (num/1000000).toFixed(2) + 'M';
      return num.toLocaleString();
    }
  
    const coinChartCtx = document.getElementById('coinChart').getContext('2d');
    let chartInstance;
    const chartCoins = [{ id: 'bitcoin', symbol: 'BTC' }, { id: 'ethereum', symbol: 'ETH' }];
    let chartIndex = 0;
  
    async function updateChart() {
      if (isChartLoading) return;
      isChartLoading = true;

      const coin = chartCoins[chartIndex];
      document.getElementById('currentCoinLabel').textContent = `${coin.symbol}/USDT`;
      
      try {
          let cached = getCachedData(`chart-${coin.id}`, 300000);
          let prices, labels;
          if(cached) { prices = cached.prices; labels = cached.labels; } 
          else {
              const res = await fetch(`${API_URL}/coin/chart/${coin.id}?vs_currency=usd&days=7`);
              if(!res.ok) throw new Error("Chart Fetch Failed");
              const data = await res.json();
              prices = data.prices.map(d => d[1]);
              labels = data.prices.map(d => new Date(d[0]).toLocaleDateString());
              setCachedData(`chart-${coin.id}`, { prices, labels });
          }
          if (chartInstance) chartInstance.destroy();
          
          chartInstance = new Chart(coinChartCtx, {
              type: 'line',
              data: {
                  labels,
                  datasets: [{
                      data: prices,
                      borderColor: '#F7A600',
                      backgroundColor: (context) => {
                          const ctx = context.chart.ctx;
                          const gradient = ctx.createLinearGradient(0, 0, 0, 240);
                          gradient.addColorStop(0, 'rgba(247, 166, 0, 0.2)');
                          gradient.addColorStop(1, 'rgba(247, 166, 0, 0)');
                          return gradient;
                      },
                      fill: true, borderWidth: 2, pointRadius: 0, tension: 0.1
                  }]
              },
              options: {
                  responsive: true, maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: { x: { display: false }, y: { display: false } },
                  interaction: { mode: 'nearest', axis: 'x', intersect: false }
              }
          });
          chartIndex = (chartIndex + 1) % chartCoins.length;
      } catch(e) { 
          console.warn("Chart load error", e); 
      } finally {
          isChartLoading = false; 
      }
    }
  
    let searchTimeout = null;
    document.getElementById('coinSearch').addEventListener('input', function (e) {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim().toLowerCase();
      
      if (!STATE.marketData.length) {
         DOM.searchResults.innerHTML = '<li style="padding:12px; color:var(--text-secondary);">Loading market data...</li>';
         return;
      }
      
      if (!query) { DOM.searchResults.innerHTML = ''; return; }
      
      searchTimeout = setTimeout(() => {
          const matches = STATE.marketData.filter(c => c.name.toLowerCase().includes(query) || c.symbol.toLowerCase().includes(query));
          DOM.searchResults.innerHTML = '';
          if(matches.length === 0) { DOM.searchResults.innerHTML = '<li style="padding:12px; color:var(--text-secondary); font-size:13px;">No coins found</li>'; return; }
          matches.slice(0, 5).forEach(c => {
              const li = document.createElement('li');
              li.innerHTML = `<a href="coin.html?coinId=${c.id}"><div style="display:flex; align-items:center; gap:8px;"><img src="${c.image}" width="16" style="border-radius:50%"><span>${c.symbol.toUpperCase()}</span></div><span style="color: var(--text-secondary)">$${c.current_price}</span></a>`;
              DOM.searchResults.appendChild(li);
          });
      }, 300);
    });
  
    function getCachedData(key, ttl) {
      const cached = localStorage.getItem(key);
      if (!cached) return null;
      try { const { data, timestamp } = JSON.parse(cached); return Date.now() - timestamp < ttl ? data : null; } catch { return null; }
    }
    function setCachedData(key, data) { localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() })); }
  
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch(`${API_URL}/auth/logout`, { method: 'POST', credentials: 'include' });
      window.location.href = 'login.html';
    });
  
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
