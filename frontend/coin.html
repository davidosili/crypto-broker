<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Trade - ProTrade</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
    :root {
      --bg-body: #121212;
      --bg-card: #1E2329;
      --bg-input: #2B3139;
      --border-color: #2B3139;
      --primary-yellow: #F7A600;
      --text-primary: #EAECEF;
      --text-secondary: #848E9C;
      --success-green: #2EBD85;
      --danger-red: #F6465D;
      --font-main: 'IBM Plex Sans', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-primary); padding-bottom: 80px; }

    /* --- TICKER STRIP --- */
    .ticker-strip {
      background: var(--bg-card); padding: 10px 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 1000;
    }
    .ticker-pair { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .ticker-price { font-size: 18px; font-weight: 600; color: var(--success-green); }
    .ticker-stats { font-size: 11px; color: var(--text-secondary); display: flex; gap: 15px; margin-top: 4px; }
    .stat-item span { color: var(--text-primary); }

    /* --- LAYOUT GRID --- */
    .trade-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 1px;
      max-width: 1200px; margin: 0 auto;
    }
    @media (max-width: 900px) { .trade-grid { grid-template-columns: 1fr; } }

    /* --- CHART SECTION --- */
    .chart-panel {
      background: var(--bg-body); height: 450px; position: relative;
      border-right: 1px solid var(--border-color);
    }
    .timeframe-toolbar {
      display: flex; gap: 10px; padding: 10px 16px;
      border-bottom: 1px solid var(--border-color); background: var(--bg-card);
    }
    .tf-btn {
      background: none; border: none; color: var(--text-secondary);
      font-size: 12px; font-weight: 600; cursor: pointer;
    }
    .tf-btn.active { color: var(--text-primary); }
    .canvas-wrapper { height: 380px; width: 100%; position: relative; }

    /* --- ORDER PANEL --- */
    .order-panel {
      background: var(--bg-card); padding: 16px; display: flex; flex-direction: column; gap: 16px;
    }
    .order-tabs { display: flex; background: var(--bg-input); border-radius: 4px; padding: 2px; }
    .order-tab {
      flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600;
      cursor: pointer; color: var(--text-secondary); border-radius: 2px;
    }
    .order-tab.buy.active { background: var(--success-green); color: white; }
    .order-tab.sell.active { background: var(--danger-red); color: white; }

    .input-group { position: relative; margin-bottom: 12px; }
    .input-group label { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
    .market-badge { background: var(--bg-body); padding: 2px 4px; border-radius: 2px; font-size: 10px; border: 1px solid var(--border-color); }
    
    .input-field {
      width: 100%; background: var(--bg-input); border: 1px solid transparent;
      padding: 12px; color: white; font-size: 14px; border-radius: 4px;
      text-align: right; font-family: monospace;
    }
    .input-field:focus { outline: none; border-color: var(--primary-yellow); }
    .input-field:disabled { opacity: 0.6; cursor: not-allowed; }
    .suffix { position: absolute; right: 12px; top: 32px; font-size: 12px; color: var(--text-secondary); }

    .percent-row { display: flex; gap: 8px; margin-bottom: 16px; }
    .pct-btn {
      flex: 1; background: var(--bg-input); border: none; color: var(--text-secondary);
      font-size: 11px; padding: 6px; border-radius: 2px; cursor: pointer;
    }
    .pct-btn:hover { background: #363c45; }

    .order-summary { font-size: 12px; color: var(--text-secondary); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .fee-display { color: var(--text-secondary); font-size: 11px; text-align: right; margin-bottom: 12px; }

    .order-btn {
      width: 100%; padding: 14px; border: none; border-radius: 4px;
      font-size: 16px; font-weight: 700; cursor: pointer; color: white;
      transition: opacity 0.2s;
    }
    .order-btn.buy { background: var(--success-green); }
    .order-btn.sell { background: var(--danger-red); }
    .order-btn:active { opacity: 0.8; }
    .order-btn:disabled { background: var(--bg-input); color: var(--text-secondary); cursor: not-allowed; }

    .balance-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }

    /* --- INFO SECTION --- */
    .info-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding: 16px;
      background: var(--bg-card); margin-top: 1px; border-top: 1px solid var(--border-color);
    }
    .info-item h4 { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .info-item p { font-size: 14px; font-weight: 500; }

    /* --- BOTTOM NAV --- */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
      background: var(--bg-card); border-top: 1px solid var(--border-color);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 1000; padding-bottom: 5px;
    }
    .bottom-nav a { display: flex; flex-direction: column; align-items: center; color: var(--text-secondary); font-size: 10px; gap: 6px; width: 25%; }
    .bottom-nav a.active { color: var(--primary-yellow); }
    .bottom-nav i { font-size: 20px; }

    #chartLoader {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(18,18,18,0.8); display: flex; justify-content: center; align-items: center;
      z-index: 5; color: var(--text-secondary); font-size: 12px;
    }
    .msg-box { text-align: center; font-size: 12px; margin-top: 10px; display: none; padding: 8px; border-radius: 4px; background: rgba(0,0,0,0.2); }
  </style>
</head>
<body>

  <div class="ticker-strip">
    <div>
      <div class="ticker-pair">
        <span id="coinSymbol">--</span>/USDT
        <span class="ticker-price" id="headerPrice">--</span>
      </div>
      <div class="ticker-stats">
        <div>24h Chg <span id="headerChange">--</span></div>
        <div>24h Vol <span id="headerVol">--</span></div>
      </div>
    </div>
    <div style="font-size: 20px; color: var(--text-secondary); cursor: pointer;" onclick="window.location.href='dashboard.html'">
      <i class="fas fa-times"></i>
    </div>
  </div>

  <div class="trade-grid">
    
    <div class="chart-panel">
      <div class="timeframe-toolbar">
        <button class="tf-btn active" onclick="updateTimeframe('1', this)">1D</button>
        <button class="tf-btn" onclick="updateTimeframe('7', this)">7D</button>
        <button class="tf-btn" onclick="updateTimeframe('30', this)">30D</button>
        <button class="tf-btn" onclick="updateTimeframe('90', this)">3M</button>
      </div>
      
      <div class="canvas-wrapper">
        <canvas id="priceChart"></canvas>
        <div id="chartLoader"><i class="fas fa-spinner fa-spin"></i>&nbsp; Loading Chart...</div>
      </div>
    </div>

    <div class="order-panel">
      <div class="order-tabs">
        <div class="order-tab buy active" onclick="setOrderType('buy')">Buy</div>
        <div class="order-tab sell" onclick="setOrderType('sell')">Sell</div>
      </div>

      <div class="balance-row">
        <span>Avail.</span>
        <span id="availBalance">-- USDT</span>
      </div>

      <div class="input-group">
        <label>
          <span>Order Price</span>
          <span class="market-badge">Market</span>
        </label>
        <input type="text" class="input-field" value="Best Market Price" disabled>
      </div>

      <div class="input-group">
        <label>Order Value</label>
        <input type="number" id="tradeAmount" class="input-field" placeholder="0.00">
        <span class="suffix">USDT</span>
      </div>

      <div class="percent-row">
        <button class="pct-btn" onclick="setPercent(25)">25%</button>
        <button class="pct-btn" onclick="setPercent(50)">50%</button>
        <button class="pct-btn" onclick="setPercent(75)">75%</button>
        <button class="pct-btn" onclick="setPercent(100)">100%</button>
      </div>

      <div class="fee-display" id="feeDisplay">Fee (0.1%): 0.00</div>

      <button id="submitBtn" class="order-btn buy" onclick="executeTrade()">Buy Long</button>
      <div id="tradeMsg" class="msg-box"></div>
    </div>
  </div>

  <div class="info-grid">
    <div class="info-item">
      <h4>Market Cap</h4>
      <p id="statCap">--</p>
    </div>
    <div class="info-item">
      <h4>Circulating Supply</h4>
      <p id="statSupply">--</p>
    </div>
    <div class="info-item">
      <h4>All Time High</h4>
      <p id="statATH">--</p>
    </div>
    <div class="info-item">
      <h4>Rank</h4>
      <p id="statRank">--</p>
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="dashboard.html">
      <i class="fas fa-home"></i><span>Home</span>
    </a>
    <a href="markets.html">
      <i class="fas fa-chart-bar"></i><span>Markets</span>
    </a>
    <a href="trade.html" class="active">
      <i class="fas fa-exchange-alt"></i><span>Trade</span>
    </a>
    <a href="assets.html">
      <i class="fas fa-wallet"></i><span>Assets</span>
    </a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_URL = location.hostname.includes('localhost') || location.hostname.includes('127.')
      ? 'http://localhost:3000/api'
      : 'https://krypt-broker.onrender.com/api';

    const coinId = new URLSearchParams(window.location.search).get('coinId');
    const ctx = document.getElementById('priceChart').getContext('2d');
    
    // State with Persistence
    let STATE = {
      coinData: null,
      currentPrice: 0,
      userBalanceUSDT: 0,
      userBalanceCoin: 0, 
      orderType: localStorage.getItem('lastOrderType') || 'buy', // ðŸ’¾ Persistent State
      chartDays: '1'
    };

    let chartInstance;
    let chartAbortController = null; // ðŸ›‘ Race condition controller

    // --- INIT ---
    async function init() {
      if (!coinId) { alert("No coin specified"); window.location.href = 'markets.html'; return; }
      
      // Initialize UI based on saved state
      setOrderType(STATE.orderType);

      // 1. Fetch Details First
      await fetchCoinDetails();
      
      // 2. Fetch Balance 
      await fetchUserBalance();
      
      // 3. Load Chart
      await loadChart(STATE.chartDays);
      
      // Auto-refresh price every 30s
      setInterval(fetchCoinDetails, 30000);
    }

    // --- 1. FETCH DETAILS ---
    async function fetchCoinDetails() {
      try {
        let data = getCachedData(`coin-${coinId}`, 60000);
        if (!data) {
          const res = await fetch(`${API_URL}/coin/coin/${coinId}`);
          if(!res.ok) throw new Error("Coin fetch failed");
          data = await res.json();
          setCachedData(`coin-${coinId}`, data);
        }

        STATE.coinData = data;
        STATE.currentPrice = data.market_data.current_price.usd;

        updateUI(data);
      } catch (err) { console.error(err); }
    }

    function updateUI(data) {
      const m = data.market_data;
      const change = typeof m.price_change_percentage_24h === 'number' ? m.price_change_percentage_24h : 0;
      const isPos = change >= 0;

      const symbol = data.symbol.toUpperCase();
      document.getElementById('coinSymbol').textContent = symbol;
      updateButtonLabel();
      
      document.getElementById('headerPrice').textContent = `$${STATE.currentPrice.toLocaleString()}`;
      document.getElementById('headerPrice').style.color = isPos ? 'var(--success-green)' : 'var(--danger-red)';
      
      const changeEl = document.getElementById('headerChange');
      changeEl.textContent = `${change.toFixed(2)}%`;
      changeEl.style.color = isPos ? 'var(--success-green)' : 'var(--danger-red)';
      
      document.getElementById('headerVol').textContent = `$${(m.total_volume.usd / 1000000).toFixed(1)}M`;

      document.getElementById('statCap').textContent = `$${(m.market_cap.usd / 1000000000).toFixed(2)}B`;
      document.getElementById('statSupply').textContent = `${(m.circulating_supply / 1000000).toFixed(1)}M`;
      document.getElementById('statATH').textContent = `$${m.ath.usd.toLocaleString()}`;
      document.getElementById('statRank').textContent = `#${data.market_cap_rank}`;
    }

    // --- 2. USER BALANCE ---
    async function fetchUserBalance() {
      try {
        const res = await fetch(`${API_URL}/trade/portfolio`, { credentials: 'include' });
        if(!res.ok) return; 
        const data = await res.json();
        
        STATE.userBalanceUSDT = data.portfolio?.USDT || 0;
        const symbol = STATE.coinData?.symbol?.toUpperCase();
        STATE.userBalanceCoin = symbol ? (data.portfolio?.[symbol] || 0) : 0;
        
        updateBalanceDisplay();
      } catch (err) { console.warn("Balance fetch failed"); }
    }

    function updateBalanceDisplay() {
      const el = document.getElementById('availBalance');
      if (STATE.orderType === 'buy') {
        el.textContent = `${STATE.userBalanceUSDT.toFixed(2)} USDT`;
      } else {
        const symbol = STATE.coinData?.symbol?.toUpperCase() || 'Coin';
        el.textContent = `${STATE.userBalanceCoin.toFixed(6)} ${symbol}`;
      }
    }

    // --- 3. CHART LOGIC (With AbortController) ---
    async function loadChart(days) {
      if (chartAbortController) chartAbortController.abort(); // ðŸ›‘ Cancel previous request
      chartAbortController = new AbortController();

      document.getElementById('chartLoader').style.display = 'flex';
      
      try {
        const res = await fetch(`${API_URL}/coin/chart/${coinId}?vs_currency=usd&days=${days}`, {
            signal: chartAbortController.signal
        });
        const data = await res.json();
        
        if(!data.prices || !data.prices.length) throw new Error("No chart data");

        const prices = data.prices.map(p => p[1]);
        const labels = data.prices.map(p => {
            const date = new Date(p[0]);
            return days === '1' ? date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : date.toLocaleDateString();
        });

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              data: prices,
              borderColor: '#F7A600',
              backgroundColor: (context) => {
                const ctx = context.chart.ctx;
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(247, 166, 0, 0.2)');
                gradient.addColorStop(1, 'rgba(247, 166, 0, 0)');
                return gradient;
              },
              borderWidth: 2,
              pointRadius: 0,
              fill: true,
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { 
                 position: 'right',
                 grid: { color: '#2B3139' },
                 ticks: { color: '#848E9C', font: {size: 10} }
              }
            },
            interaction: { mode: 'index', intersect: false }
          }
        });

      } catch (err) { 
        if (err.name !== 'AbortError') console.error("Chart error", err); 
      } finally { 
        document.getElementById('chartLoader').style.display = 'none'; 
      }
    }

    function updateTimeframe(days, btn) {
      document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      STATE.chartDays = days;
      loadChart(days);
    }

    // --- 4. TRADE LOGIC (With Fees) ---
    function setOrderType(type) {
      STATE.orderType = type;
      localStorage.setItem('lastOrderType', type); // ðŸ’¾ Save Preference
      
      const buyTab = document.querySelector('.order-tab.buy');
      const sellTab = document.querySelector('.order-tab.sell');
      const btn = document.getElementById('submitBtn');
      
      if(type === 'buy') {
        buyTab.classList.add('active');
        sellTab.classList.remove('active');
        btn.className = 'order-btn buy';
      } else {
        sellTab.classList.add('active');
        buyTab.classList.remove('active');
        btn.className = 'order-btn sell';
      }
      
      updateButtonLabel();
      updateBalanceDisplay();
      updateFeeDisplay();
    }

    function updateButtonLabel() {
        const symbol = STATE.coinData?.symbol?.toUpperCase() || '';
        const btn = document.getElementById('submitBtn');
        btn.textContent = `${STATE.orderType === 'buy' ? 'Buy' : 'Sell'} ${symbol}`;
    }

    function setPercent(pct) {
      const input = document.getElementById('tradeAmount');
      if (STATE.orderType === 'buy') {
        const amount = (STATE.userBalanceUSDT * pct) / 100;
        input.value = amount.toFixed(2);
      } else {
        const coinVal = (STATE.userBalanceCoin * pct) / 100;
        const usdVal = coinVal * STATE.currentPrice;
        input.value = usdVal.toFixed(2);
      }
      updateFeeDisplay();
    }

    // ðŸ’° Fee Calculation (0.1%)
    document.getElementById('tradeAmount').addEventListener('input', updateFeeDisplay);

    function updateFeeDisplay() {
        const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
        const fee = amount * 0.001; // 0.1%
        const el = document.getElementById('feeDisplay');
        const symbol = STATE.orderType === 'buy' ? 'USDT' : 'USDT Value';
        el.textContent = `Fee (0.1%): ${fee.toFixed(4)} ${symbol}`;
    }

    async function executeTrade() {
      const usdAmount = parseFloat(document.getElementById('tradeAmount').value);
      const btn = document.getElementById('submitBtn');
      
      if (!usdAmount || usdAmount <= 0) {
        showMessage("Please enter a valid amount", false);
        return;
      }
      
      // Balance Checks
      if (STATE.orderType === 'buy' && usdAmount > STATE.userBalanceUSDT) {
         showMessage(`Insufficient USDT. Balance: $${STATE.userBalanceUSDT.toFixed(2)}`, false);
         return;
      }
      
      const estimatedCoin = usdAmount / STATE.currentPrice;
      if (STATE.orderType === 'sell' && estimatedCoin > STATE.userBalanceCoin) {
         showMessage(`Insufficient Coin Balance`, false);
         return;
      }

      btn.disabled = true;
      btn.textContent = "Processing...";

      try {
        const res = await fetch(`${API_URL}/trade/place`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            type: STATE.orderType,
            coin: STATE.coinData.symbol.toUpperCase(),
            amount: estimatedCoin,
            price: STATE.currentPrice
          })
        });

        const result = await res.json();
        
        if (res.ok) {
           showMessage("âœ… Order Filled Successfully!", true);
           fetchUserBalance(); 
           document.getElementById('tradeAmount').value = '';
           updateFeeDisplay();
        } else {
           showMessage(`âŒ ${result.message}`, false);
        }
      } catch (err) { console.error(err); showMessage("Network Error", false); }
      finally {
         btn.disabled = false;
         updateButtonLabel();
      }
    }
    
    function showMessage(msg, isSuccess) {
        const el = document.getElementById('tradeMsg');
        el.style.display = 'block';
        el.style.color = isSuccess ? 'var(--success-green)' : 'var(--danger-red)';
        el.textContent = msg;
        setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    // --- HELPERS ---
    function getCachedData(key, ttl) {
      const cached = localStorage.getItem(key);
      if (!cached) return null;
      try { const { data, timestamp } = JSON.parse(cached); return Date.now() - timestamp < ttl ? data : null; } catch { return null; }
    }
    function setCachedData(key, data) { localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() })); }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
