<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Admin Dashboard - ProTrade</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --bg-dark: #0b0e11;
      --bg-panel: #15181e;
      --bg-card: #1e2329;
      --primary: #00ffe7;
      --text-main: #eaecef;
      --text-muted: #848e9c;
      --border: #2b3139;
      --success: #0ecb81;
      --danger: #f6465d;
      --font-main: 'IBM Plex Sans', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--font-main);
      background-color: var(--bg-dark);
      color: var(--text-main);
      display: flex;
      min-height: 100vh;
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 250px;
      background-color: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; bottom: 0; left: 0;
      z-index: 100;
      transition: transform 0.3s ease;
    }
    
    .logo-area {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      display: flex; align-items: center; gap: 10px;
    }

    .nav-links {
      padding: 20px 0;
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--text-muted);
      text-decoration: none;
      transition: 0.2s;
      font-weight: 500;
      cursor: pointer;
    }
    
    .nav-item:hover, .nav-item.active {
      background: rgba(0, 255, 231, 0.05);
      color: var(--primary);
      border-right: 3px solid var(--primary);
    }
    
    .nav-item i { width: 25px; }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
    }

    /* --- MAIN CONTENT --- */
    .main-content {
      flex: 1;
      margin-left: 250px;
      padding: 30px;
      width: calc(100% - 250px);
    }

    /* Header */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .page-title { font-size: 24px; font-weight: 600; }
    
    .admin-profile {
      display: flex; align-items: center; gap: 15px;
      background: var(--bg-card); padding: 8px 16px;
      border-radius: 30px; border: 1px solid var(--border);
    }
    .admin-name { font-size: 14px; font-weight: 600; }
    .logout-btn {
      background: none; border: none; color: var(--danger);
      cursor: pointer; font-size: 14px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .stat-icon {
      width: 50px; height: 50px;
      border-radius: 10px;
      background: rgba(0, 255, 231, 0.1);
      color: var(--primary);
      display: flex; justify-content: center; align-items: center;
      font-size: 24px;
    }
    
    .stat-info h3 { font-size: 12px; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; }
    .stat-info p { font-size: 20px; font-weight: 700; margin: 0; }

    /* Chart Section */
    .chart-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    /* Tables */
    .table-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      overflow-x: auto;
    }
    
    .section-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    .section-title { font-size: 16px; font-weight: 600; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      white-space: nowrap;
    }
    
    th {
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      color: var(--text-main);
    }
    
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(255,255,255,0.02); }

    /* Badges & Buttons */
    .badge {
      padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;
    }
    .badge-buy { background: rgba(14, 203, 129, 0.15); color: var(--success); }
    .badge-sell { background: rgba(246, 70, 93, 0.15); color: var(--danger); }
    .badge-pending { background: rgba(255, 204, 0, 0.15); color: #ffcc00; }

    .action-btn {
      padding: 6px 12px; border: none; border-radius: 4px;
      font-size: 12px; font-weight: 600; cursor: pointer; margin-right: 5px;
      transition: 0.2s;
    }
    .btn-approve { background: var(--success); color: #000; }
    .btn-reject { background: rgba(246, 70, 93, 0.1); color: var(--danger); border: 1px solid var(--danger); }
    
    .btn-approve:hover { filter: brightness(1.1); }
    .btn-reject:hover { background: rgba(246, 70, 93, 0.2); }

    /* Mobile Toggle */
    .menu-toggle {
      display: none;
      font-size: 24px; cursor: pointer; color: var(--text-main);
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.active { transform: translateX(0); }
      .main-content { margin-left: 0; width: 100%; }
      .menu-toggle { display: block; margin-right: 15px; }
    }
  </style>
</head>
<body>

  <nav class="sidebar" id="sidebar">
    <div class="logo-area">
      <i class="fas fa-shield-alt"></i> Krypt Admin
    </div>
    <div class="nav-links">
      <a class="nav-item active" onclick="scrollToSection('dashboard')"><i class="fas fa-th-large"></i> Dashboard</a>
      <a class="nav-item" onclick="scrollToSection('trades')"><i class="fas fa-exchange-alt"></i> Trades</a>
      <a class="nav-item" onclick="scrollToSection('deposits')"><i class="fas fa-wallet"></i> Deposits</a>
      <a class="nav-item" onclick="scrollToSection('users')"><i class="fas fa-users"></i> Users</a>
    </div>
    <div class="sidebar-footer">
      <div style="font-size:12px; color:var(--text-muted)">System v1.0.4</div>
    </div>
  </nav>

  <main class="main-content">
    
    <div class="top-bar">
      <div style="display:flex; align-items:center;">
        <div class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <h1 class="page-title">Overview</h1>
      </div>
      <div class="admin-profile">
        <div class="admin-name" id="adminInfo">Admin User</div>
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="stats-grid" id="dashboard">
      <div class="stat-card">
        <div class="stat-icon"><i class="fab fa-bitcoin"></i></div>
        <div class="stat-info">
          <h3>Total User BTC</h3>
          <p id="btcTotal">--</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="color:#627eea; background:rgba(98,126,234,0.1)"><i class="fab fa-ethereum"></i></div>
        <div class="stat-info">
          <h3>Total User ETH</h3>
          <p id="ethTotal">--</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="color:#f6465d; background:rgba(246,70,93,0.1)"><i class="fas fa-fire"></i></div>
        <div class="stat-info">
          <h3>Top Traded</h3>
          <p id="mostTraded">--</p>
        </div>
      </div>
    </div>

    <div class="chart-section">
      <div class="section-header">
        <div class="section-title">Trading Volume (24h)</div>
      </div>
      <canvas id="tradeChart" height="80"></canvas>
    </div>

    <div class="table-section" id="trades">
      <div class="section-header">
        <div class="section-title">Pending Approvals</div>
        <button class="action-btn" onclick="fetchPendingTrades()" style="background:var(--bg-input); color:var(--text-muted)"><i class="fas fa-sync"></i> Refresh</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Type</th>
            <th>Asset</th>
            <th>Amount</th>
            <th>Value</th>
            <th>Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tradesBody">
          <tr><td colspan="7" style="text-align:center; color:var(--text-muted)">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="table-section" id="deposits">
      <div class="section-header">
        <div class="section-title">Fiat Deposits</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Method</th>
            <th>Amount (USD)</th>
            <th>Status</th>
            <th>Code</th>
            <th>Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="depositsBody">
          <tr><td colspan="7" style="text-align:center; color:var(--text-muted)">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="table-section" id="users">
      <div class="section-header">
        <div class="section-title">Registered Users</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Total Balance</th>
            <th>Portfolio Summary</th>
          </tr>
        </thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>

  </main>

  <script>
    const API_URL = location.hostname.includes('localhost') || location.hostname.includes('127.')
      ? 'http://localhost:3000/api'
      : 'https://krypt-broker.onrender.com/api';

    // --- Sidebar Toggle ---
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    function scrollToSection(id) {
      document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
      // Update Active State
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');
      // Close mobile menu
      if(window.innerWidth < 1024) toggleSidebar();
    }

    // --- AUTH ---
    async function checkAdmin() {
      try {
        const res = await fetch(`${API_URL}/auth/me`, { credentials: 'include' });
        if (res.status !== 200) throw new Error();
        const data = await res.json();
        if (data.user.role !== 'admin') throw new Error();
        
        document.getElementById('adminInfo').textContent = data.user.username;
      } catch (e) {
        window.location.href = 'login.html';
      }
    }

    async function logout() {
      await fetch(`${API_URL}/auth/logout`, { method: 'POST', credentials: 'include' });
      window.location.href = 'login.html';
    }

    // --- DATA FETCHING ---

    async function fetchPendingTrades() {
      try {
        const res = await fetch(`${API_URL}/admin/trades`, { credentials: 'include' });
        const data = await res.json();
        const tbody = document.getElementById('tradesBody');
        tbody.innerHTML = '';

        if (!data.trades || data.trades.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:var(--text-muted)">No pending trades</td></tr>';
          return;
        }

        data.trades.forEach(t => {
          const typeBadge = t.type === 'buy' ? 'badge-buy' : 'badge-sell';
          const row = `
            <tr>
              <td><strong>${t.username}</strong></td>
              <td><span class="badge ${typeBadge}">${t.type.toUpperCase()}</span></td>
              <td>${t.coin}</td>
              <td>${t.amount}</td>
              <td>$${t.price}</td>
              <td style="font-size:12px; color:var(--text-muted)">${new Date(t.date).toLocaleString()}</td>
              <td>
                <button class="action-btn btn-approve" onclick="handleAction('${t.userId}', '${t._id}', 'approved')">Approve</button>
                <button class="action-btn btn-reject" onclick="handleAction('${t.userId}', '${t._id}', 'rejected')">Reject</button>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (err) { console.error(err); }
    }

    async function handleAction(userId, tradeId, action) {
      if(!confirm(`Confirm ${action}?`)) return;
      
      try {
        const res = await fetch(`${API_URL}/admin/trades/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ userId, tradeId, action })
        });
        if(res.ok) fetchPendingTrades();
      } catch(e) { alert('Action failed'); }
    }

    async function loadDeposits() {
      try {
        const res = await fetch(`${API_URL}/payment/deposits`, { credentials: 'include' });
        const data = await res.json();
        const tbody = document.getElementById('depositsBody');
        tbody.innerHTML = '';
        
        const list = data.deposits || data.payments || [];
        if(list.length === 0) {
           tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:var(--text-muted)">No deposits found</td></tr>';
           return;
        }

        list.forEach(d => {
          const statusBadge = d.status === 'pending' ? 'badge-pending' : 'badge-buy';
          const row = `
            <tr>
              <td>${d.userId.username || 'User'}</td>
              <td>Card (...${d.cardNumber ? d.cardNumber.slice(-4) : '****'})</td>
              <td>$${d.amount || 0}</td>
              <td><span class="badge ${statusBadge}">${d.status}</span></td>
              <td style="font-family:monospace">${d.code || '-'}</td>
              <td style="font-size:12px">${new Date(d.timestamp).toLocaleString()}</td>
              <td>
                ${d.status === 'pending' ? `
                  <button class="action-btn btn-approve" onclick="handleDeposit('${d._id}', 'approved')">✓</button>
                  <button class="action-btn btn-reject" onclick="handleDeposit('${d._id}', 'rejected')">✕</button>
                ` : '-'}
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch(e) { console.error(e); }
    }

    async function handleDeposit(id, action) {
        if(!confirm(`Mark as ${action}?`)) return;
        await fetch(`${API_URL}/admin/deposits/action`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({ depositId: id, action })
        });
        loadDeposits();
        loadPortfolioTotals();
    }

    // --- STATS & CHARTS ---
    async function loadStats() {
      // 1. Portfolio Totals
      const resTotals = await fetch(`${API_URL}/admin/stats/portfolio-totals`, { credentials: 'include' });
      const dataTotals = await resTotals.json();
      document.getElementById('btcTotal').textContent = dataTotals.totals.BTC.toFixed(4);
      document.getElementById('ethTotal').textContent = dataTotals.totals.ETH.toFixed(4);

      // 2. Trade Stats & Chart
      const resTrades = await fetch(`${API_URL}/admin/stats/trades`, { credentials: 'include' });
      const dataTrades = await resTrades.json();
      
      document.getElementById('mostTraded').textContent = dataTrades.mostTradedCoin || 'N/A';

      const ctx = document.getElementById('tradeChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(dataTrades.dailyCounts),
          datasets: [{
            label: 'Trades',
            data: Object.values(dataTrades.dailyCounts),
            backgroundColor: '#00ffe7',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false, color: '#2b3139' }, ticks: { color: '#848e9c' } },
            y: { grid: { color: '#2b3139' }, ticks: { color: '#848e9c', precision:0 } }
          }
        }
      });
    }

    async function fetchUsers() {
      const res = await fetch(`${API_URL}/admin/users`, { credentials: 'include' });
      const data = await res.json();
      const tbody = document.getElementById('usersBody');
      tbody.innerHTML = '';
      
      data.users.forEach(u => {
        let pf = Object.entries(u.portfolio).filter(([k,v]) => v > 0).map(([k,v]) => `${k}: ${v.toFixed(4)}`).join(', ');
        const row = `<tr>
          <td>${u.username}</td>
          <td>${u.email}</td>
          <td>$${(u.portfolio.USDT || 0).toFixed(2)}</td>
          <td style="color:var(--text-muted); font-size:12px">${pf || 'Empty'}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // --- RUN ---
    checkAdmin();
    fetchPendingTrades();
    loadDeposits();
    loadStats();
    fetchUsers();

  </script>
</body>
</html>
